container_commands:

  00_setup_epel:
    command: sudo yum-config-manager --enable epel
  01_setup_filestore:
    command: sudo yum install -y bindfs autoconf fuse fuse-libs fuse-devel libarchive libarchive-devel amazon-efs-utils
  02_make_archivemount:
    command: |
      cd /tmp
      rm -rf archivemount-0.8.12
      rm -f archivemount-0.8.12.tar.gz
      wget https://www.cybernoia.de/software/archivemount/archivemount-0.8.12.tar.gz
      tar -xvzf archivemount-0.8.12.tar.gz
      cd archivemount-0.8.12
      # autoreconf -i
      ./configure && make && sudo make install
      if [ -f /usr/bin/archivemount ]; then unlink /usr/bin/archivemount; fi
      ln -s /usr/local/bin/archivemount /usr/bin/archivemount

#  04_get_certbot:
#    command: |
#      cd /tmp
#      if [ ! -f certbot-auto ]
#      then
#        yum install -y augeas-libs libffi-devel python27-tools system-rpm-config
#        wget https://dl.eff.org/certbot-auto
#        chmod a+x certbot-auto
#        rm -rf /etc/letsencrypt/live/file-upload-dev.32vnp6pmmu.us-east-1.elasticbeanstalk.com*
#        rm -rf /etc/letsencrypt/archive/file-upload-dev.32vnp6pmmu.us-east-1.elasticbeanstalk.com*
#        ./certbot-auto   certonly --debug --non-interactive --email phil.ayres@consected.com.com --agree-tos --standalone --domains file-upload-dev.32vnp6pmmu.us-east-1.elasticbeanstalk.com --keep-until-expiring --pre-hook "service nginx stop; service passenger stop"
#        rm -f /etc/pki/tls/certs/server.key
#        rm -f /etc/pki/tls/certs/server.crt
#        ln -s /etc/letsencrypt/archive/file-upload-dev.32vnp6pmmu.us-east-1.elasticbeanstalk.com*/privkey1.pem /etc/pki/tls/certs/server.key
#        ln -s /etc/letsencrypt/archive/file-upload-dev.32vnp6pmmu.us-east-1.elasticbeanstalk.com*/fullchain1.pem /etc/pki/tls/certs/server.crt
#        service passenger start
#      fi

  05_setup_efs:
    command: |
      FS_ROOT=/efs1
      FS_DIR=main
      MOUNT_ROOT=/mnt/fphsfs
      WEBAPP_USER=webapp
      mkdir -p /efs1
      getent group 599 || groupadd --gid 599 nfs_store_all_access
      getent group 600 || groupadd --gid 600 nfs_store_group_0
      getent group 601 || groupadd --gid 601 nfs_store_group_1
      getent passwd 600 || useradd --user-group --uid 600 nfsuser
      usermod -a --groups 599 $WEBAPP_USER
      mkdir -p $FS_ROOT
      mountpoint -q $FS_ROOT || mount -t efs -o tls fs-c302a188:/ $FS_ROOT
      mkdir -p $MOUNT_ROOT/gid600
      mkdir -p $MOUNT_ROOT/gid601
      mountpoint -q $MOUNT_ROOT/gid600 || bindfs --map=@600/@599 --create-for-group=600 --create-for-user=600 --chown-ignore --chmod-ignore --create-with-perms='u=rwD:g=rwD:o=' $FS_ROOT/$FS_DIR $MOUNT_ROOT/gid600
      mountpoint -q $MOUNT_ROOT/gid601 || bindfs --map=@601/@599 --create-for-group=601 --create-for-user=600 --chown-ignore --chmod-ignore --create-with-perms='u=rwD:g=rwD:o=' $FS_ROOT/$FS_DIR $MOUNT_ROOT/gid601
