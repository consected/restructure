<div class="col-md-12 col-md-offset-6 well">
<h2><%= @resource_name.to_s.humanize %> Two-Factor Authentication Setup</h2>
  <div class="template-block"><%= template_block 'ui 2fa setup' %></div>

<%
  # Double check the logic to make sure we don't accidentally show the QR Code at the wrong time
  if @resource.otp_secret.present? && !@resource.otp_required_for_login
  # Prepare QR Code and test that the user can enter a two-factor authentication code
    qrcode = RQRCode::QRCode.new(@resource.two_factor_auth_uri, level: :m)
       qrpng = qrcode.as_png resize_gte_to: false,
        resize_exactly_to: false,
        fill: 'white',
        color: 'black',
        size: 240,
        border_modules: 4,
        module_px_size: 6

    image = Base64.encode64 qrpng.to_datastream.to_s

    test_otp_path = send("#{@resource_name.pluralize}_test_otp_path")
%>
<p>
  Scan this QR Code with the authenticator app on your smartphone.
</p>
<p>
  If you don't have an authenticator app you will need to install one before you can continue logging in.
  <a href="#authenticator_apps" data-toggle="collapse">View a list of compatible apps</a>
</p>
<div id="authenticator_apps" class="collapse">
  <h3>Authenticator Apps</h3>
  <p>
    The following are just a few well known authenticator apps that can create time-based two-factor authentication codes.
    If your organization has not already provided you with an app, select one of these to install through your smartphone app store.
  </p>
  <ul>
    <li>Duo Mobile</li>
    <li>Google Authenticator</li>
    <li>Microsoft Authenticator</li>
    <li>LastPass Authenticator</li>
    <li>Authy</li>
  </ul>
  <br />
</div>
<p>
  <img src="data:image/png;base64,<%=image%>">
</p>
<p>
  When you have setup the barcode, you need to enter a new two-factor authentication code generated by the app to confirm configuration has been successful.
</p>

<%= form_tag(test_otp_path,  method: :post, id: 'form-validate-otp') do  %>

  <div class="form-group-non">
    <%= label_tag :otp_attempt, 'Enter Two-Factor Authentication Code' %><br />
    <%= password_field_tag :otp_attempt, '', autocomplete: "off", class: 'form-control', inputmode: "numeric", minlength: "6", maxlength: "6", value: '', pattern: "\\d{6}" %>
  </div>

  <div class="actions">
    <%= submit_tag "Submit Code", class: "btn btn-primary" %>
  </div>
<% end %>


<% end %>
</div>