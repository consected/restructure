<div class="report-criteria container-fluid">
  <div class="row">
    <div class="col-sm-22 col-sm-offset-1">
      <div class="well">
        <%= link_to "report library", reports_path, class: 'btn btn-info pull-right'%><h1><%=@report.name%></h1>
        <p><%= @report.description.gsub("\n", "<br />").html_safe %></p>
        <p>&nbsp;</p>
        <div>
            <%= form_tag report_path(@report.id), method: :get, class: 'form-formatted', id: "report_query_form" do %>
            <div class="row">
              <% @report.search_attributes.each do |name, type| %>
                <div class="col-md-6" style="padding-bottom: 1em;">                
                <%= report_field name, type, @report.search_attr_values[name] %>
                </div>
              <%end%>
              
            </div>
            <div class="">
              <%= submit_tag :table, class: "btn btn-primary" %>
              <%= submit_tag "CSV", name: :format, value: "csv", class: "btn btn-primary" %>
              <%= submit_tag "JSON", id: "submit_query_to_json", name: :format, value: "json", class: "btn btn-primary target_new_window" %>

            </div>
            <%end%>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
          $('a.btn[data-attribute]').click(function(ev){
          ev.preventDefault();
          var da = $(this).attr('data-attribute');
          
          var v = $('#search_attrs_'+da);
          var newval = v.val();
          if(newval.length > 0)newval += "\n";
          newval += $('#multiple_attrs_'+da).val();
          v.val(newval);
          
          
        });
</script>
<p>&nbsp;</p>
<% if @results %>
<% rt = @report.result_tables_by_index || []%>
<div class="data-results" data-subscription="admin-list" >
  <div data-result="admin-list">    
    <div class="row">
      <div class="col-sm-24 ">
      
          <h2>Results <span class="result-count"><%=@results.count%></span> over <span class="field-count"><%=@results.nfields%></span> fields</h2>
    <div id="admin-edit-" data-preprocessor="admin-edit-form" data-subscription="admin-edit-form-" class="new-block new-below"></div>

    <table class="table tablesorter admin-list">
      <thead>
        <tr>
          <th class="no-sort"></th>
          <% i = 0 %>
          <% @results.fields.each do |col| %>
            <th><p><%=col%></p>
              <p class="small"><%=rt[i] %></p>
            </th>
          <%  i += 1%>
          <% end %>
        </tr>
      </thead>
      <tbody>
        
        <% @results.each_row do |list_item| %>
          
          
          <tr class="">
            <td></td>
            <% i = 0 %>
            
            <% list_item.each do |col| %>
            <td data-col-type="<%=@results.fields[i] %>"  data-col-table="<%=rt[i] %>"><%= col %></td>
            <%  i += 1%>
            <% end %>

          </tr>
        <% end %>
      </tbody>
    </table>


    
      </div>
    </div>
  </div>
</div>

<script>
      
      window.setTimeout(function(){
      
        var tables = {trackers:
                {protocols: 'protocol_id', sub_processes: 'sub_process_id', protocol_events: 'protocol_event_id', item_type_names: 'item_type'},
            tracker_history:
                {protocols: 'protocol_id', sub_processes: 'sub_process_id', protocol_events: 'protocol_event_id', item_type_names: 'item_type'},
                masters:
                        {accuracy_scores: 'rank'}
        };

        for(var t in tables){
          if(tables.hasOwnProperty(t)){
            var table = tables[t];
            if($('td[data-col-table="'+t+'"]').length > 0 ){
              for(var i in table){

                if(tables.hasOwnProperty(t)){

                  col_types = tables[t];
                  var idname = col_types[i];

                  _fpa.set_definition(i, function(){                                                
                    var pe = _fpa.cache(i);
                    var cells = $('td[data-col-type="'+idname+'"]');
                    cells.each(function(){
                      var cell = $(this);
                      var d = cell.html();    
                      var p = _fpa.get_item_by('id', pe, d);
                      if(p) cell.append(' <em>'+p.name+'</em>');
                    });
                  });
                }
              }
            }
          }
        }


        $('#report_query_form input[type="submit"]').click(function(){

          if($(this).hasClass('target_new_window')){
            $('#report_query_form').attr('target', '_blank');      
          }else{
            $('#report_query_form').attr('target', '_top');      
          }

        });        

        
      }, 100);
    </script>
<% end %>
<%=  render partial: 'admin_handler/index_actions'  %>