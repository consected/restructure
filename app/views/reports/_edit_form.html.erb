<div class="data-results">
  <div data-result="report-edit-form-"  class="admin-edit-form">
<% object_instance = @report_item %>
<table>
<%= form_for(object_instance, url: (object_instance.id ? url_for(controller: controller_name, action: :update, report_id: @report.id, id: object_instance.id) : url_for(controller: controller_name, action: :create, report_id: @report.id) ), class: "inline-form", remote: true, html: {'data-result-target' => '#report-edit-results', 'data-template' => "edit-report-result",  'data-object-id' => object_instance.id }) do |f| %>
<tr id="report-item-edit-<%=object_instance.id%>">
  <%= render partial: 'form_errors' %>
  <td class="report-el report-edit-btn-cell">
    <%= hidden_field_tag "filter[#{params[:filter].first.first}]", params[:filter].first.last  if params[:filter]%>
    <%= report_edit_cancel %><button class="btn btn-primary report-edit-submit"><i class="glyphicon glyphicon-ok"></i></button>
  </td>
  <% if object_instance.respond_to?(:id) %>
   <td class="report-el"><%= object_instance.id %></td>
  <% end %>
  <% (permitted_params - [:id]).each do |field_name_sym| %>

        <%
          form_object_instance = object_instance
          form_object_item_type_us = form_object_instance.item_type_us
          label_redefined = false

          field_name = field_name_sym.to_s
          col = form_object_instance.class.columns_hash[field_name]
          # raise FphsException.new "Column #{field_name_sym} does not appear in the columns #{form_object_instance.class.columns_hash.map{|k,v| k}}" unless col
          # External IDs and master crosswalk ids (msid) do not feature in the item. Ignore if they appear
          column_type = :string
          column_type = col.type if col

          if form_object_item_type_us.start_with? 'activity_log_'
            general_selection_name = form_object_item_type_us
          else
            general_selection_name = form_object_item_type_us.pluralize
          end

          local_vars = {locals: {
            form: f,
            field_name_sym: field_name_sym,
            field_name: field_name,
            column_type: column_type,
            general_selection_name: general_selection_name,
            form_object_instance: form_object_instance,
            form_object_item_type_us: form_object_item_type_us,
            caption_before: {}
            }
          }
          local_vars[:locals][:locals] = local_vars[:locals]

          # One time only, redefine the label method for this specific form fields instance
          unless label_redefined
            def f.label *args
              ""
            end
            label_redefined = true
          end
        %>
        <td class="report-el">
          <%= render local_vars.merge(partial: 'common_templates/edit_form_field') %>
        </td>


  <% end %>
</tr>
<% end %>
</table>
      <div id="report-edit-results" data-template="edit-report-result"></div>
  </div>
</div>
