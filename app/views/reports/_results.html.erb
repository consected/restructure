
<% rt = @report.result_tables_by_index || []%>
<div class="data-results" data-subscription="admin-list" >
  <div data-result="admin-list">    
      <p class="text-center"><%= link_to "link to report", report_path(id: @report.id, search_attrs: params[:search_attrs].merge(no_run: 'true')) if current_admin || current_user.can?(:view_reports)%> </p>      
    <%= render partial: 'filter_on'  if @report.filtering_on %>
    <% if current_admin && @report.clean_sql%>
    <p class="text-center"><a href="#clean-sql" data-toggle="collapse" class="collapsed">show SQL</a></p>
    <div class="row">          
        <div class="col-md-20 col-md-offset-2 collapse" id="clean-sql">
          <pre><%=@report.clean_sql.html_safe%>
          </pre>
        </div>
    </div>
    <% end %>
      
    <div class="row" style="background-color: #eee;">
      <div class="col-sm-22 col-sm-offset-1 ">
      
        <h3 class="text-right hidden"><span class="result-count"><%=@results.count%></span> <%=@results.count == 1 ? 'row' : 'rows'%></h3>
        <div id="admin-edit-" data-preprocessor="admin-edit-form" data-subscription="admin-edit-form-" class="new-block new-below"></div>
      </div>
    </div>           
    <div  id="report-results-block">
        <table class="" style="margin:1em;">
          <thead>
            <tr>
              
              <% i = 0 %>
              <% @results.fields.each do |col| %>
                <th><p><%=col%></p>
                  <p class="small"><%=rt[i] %></p>
                </th>
              <%  i += 1%>
              <% end %>
            </tr>
          </thead>
          <tbody>

            <% @results.each_row do |list_item| %>


              <tr class="">
               
                <% i = 0 %>

                <% list_item.each do |col| %>
                <td data-col-type="<%=@results.fields[i] %>"  data-col-table="<%=rt[i] %>"><%= col %></td>
                <%  i += 1%>
                <% end %>

              </tr>
            <% end %>
          </tbody>
        </table>
    </div>
      
    
  </div>
</div>

<script>
      
      window.setTimeout(function(){
        $('table').addClass('table tablesorter');
        var tables = {trackers:
                {protocols: 'protocol_id', sub_processes: 'sub_process_id', protocol_events: 'protocol_event_id', users: 'user_id'},
            tracker_history:
                {protocols: 'protocol_id', sub_processes: 'sub_process_id', protocol_events: 'protocol_event_id', users: 'user_id'},
            masters:
                {accuracy_scores: 'rank'},
            player_infos:
                {accuracy_scores: 'rank', users: 'user_id'},
            player_contacts:
                {'general_selections-item_type+player_contacts_rank': 'rank', users: 'user_id'},
            addresses:
                {'general_selections-item_type+addresses_rank': 'rank', users: 'user_id'}
        };

        for(var t in tables){
          if(tables.hasOwnProperty(t)){
            var table = tables[t];
            
            $('td[data-col-type="master_id"]').on('click', function(){
              window.open('/masters/'+$(this).html(), "msid");
              $('.item-selected').removeClass('item-selected');
              $(this).addClass('item-selected');
            }).addClass('hover-link');
            
            $('td[data-col-type="msid"]').on('click', function(){
              window.open('/masters/'+$(this).html()+'?type=msid', "msid");
              $('.item-selected').removeClass('item-selected');
              $(this).addClass('item-selected');
            }).addClass('hover-link');
            
            if($('td[data-col-table="'+t+'"]').length > 0 ){
              for(var i in table){

                if(tables.hasOwnProperty(t)){

                  col_types = tables[t];
                  var idname = col_types[i];
                  console.log("Getting " + i + " for " + idname + ' in ' + t);
                  _fpa.set_definition(i, function(){                                                
                    var pe = _fpa.cache(i);
                    var cells = $('td[data-col-table="'+t+'"][data-col-type="'+idname+'"]');
                    cells.each(function(){
                      var cell = $(this);
                      var d = cell.html();    
                      var p = _fpa.get_item_by('value', pe, d);
                      
                      if(!p || p.value == null){
                        p = _fpa.get_item_by('id', pe, d);                        
                      }
                      if(p) cell.append(' <em>'+p.name+'</em>');
                    });
                  });
                }
              }
            }
          }
        }
        
        _fpa.form_utils.setup_tablesorter($('#report-results-block'));


        
        
      }, 500);
    </script>