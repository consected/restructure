# @library sleep enabled_if
# @library sleep filestore_container
# @library sleep notification_base

_definitions:

  ####
  # Boilerplace for notifying roles
  # Override the subject: and if: structures to refine operation
  ####

  # Default email - just add roles or users
  notify_email_default: &notify_email_default
    type: email
    layout_template: sleep notification layout
    content_template: sleep notification message
    subject: "Sleep Study App: Discussion Message - {{referring_record.id}}"
    extra_substitutions:
      reason: 'New Discussion Message'
      extra_text: |
        Discussion Subject: *{{referring_record.notes}}*
      panel_tab: activity-log--sleep-assignment-discussions



  # Default SMS - just add roles or users
  notify_sms_default: &notify_sms_default
    type: sms
    layout_template: standard sms layout
    content_template: sleep sms notification
    subject: "Sleep Study Discussion"


###############################################
# @library sleep notify_roles
# @library sleep discussions
###############################################



start_new_discussion:
  label: '{{notes}}'
  button_label: Start New Discussion
  <<: *setup_discussion

  field_options:
    <<: *start_discussion_field_options
    tag_select_contact_role:
      edit_as:
        alt_options:
          HMS Phone Screen Interviewer: hms phone screener
          BWH Phone Screen Interviewer: bwh phone screener
          All Interventionists: all interventionists
          Assigned Interventionist: assigned interventionist
          PI: pi


  showable_if:
    all:
      activity_log__sleep_assignment_discussions:
        id:
          this: id
        tag_select_contact_role:
          condition: '&&'
          value: current_user_role_names


  references:
    - activity_log__sleep_assignment_discussion:
        label: New Message
        from: this
        add: many
        prevent_disable: true
        add_with:
          extra_log_type: general_discussion
          prev_activity_type: general_discussion
        filter_by:
          extra_log_type: general_discussion



general_discussion:
  label: Message

  <<: *discussion_message_defaults
