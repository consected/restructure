_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  # Boilerplate for notifying the staff member that initiated the phone screen checklist
  # Override the subject: and if: structures to refine operation
  notify_ps_checklist_initiator: &notify_ps_checklist_initiator
    type: email
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
        user_id: return_value
    if:
      all:
        this:
          contact_role: staff member

  # Boilerplate for notifying the staff member that initiated the baseline checklist
  # Override the subject: and if: structures to refine operation
  notify_baseline_checklist_initiator: &notify_baseline_checklist_initiator
    type: email
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review
        user_id: return_value
    if:
      all:
        this:
          contact_role: baseline initiator


  notify_reviewer: &notify_reviewer
    type: email
    role: email - inex reviewer
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"
    if:
      all:
        this:
          contact_role: mednav reviewer

  notify_pi: &notify_pi
    type: email
    role: email - inex pi
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"
    if:
      all:
        this:
          contact_role: pi


  notify_tms: &notify_tms
    type: email
    role: email - inex tms
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: TMS eligibility review message"
    if:
      all:
        this:
          contact_role: tms


  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: supporting documents
        label: Supporting Documents
        create_with_role: nfs_store group 600


  contact_defaults: &contact_defaults
    fields:
      - notes
      - prev_activity_type
      - contact_role

    field_options:
      prev_activity_type:
        edit_as:
          field_type: fixed_type

      contact_role:
        edit_as:
          field_type: select_contact
          alt_options:
            Staff Member: staff member
            Baseline Initiator: baseline initiator
            MedNav: mednav reviewer
            PI: pi
            TMS: tms

    show_if:
      prev_activity_type:
        never: true
    view_options:
      data_attribute: notes

    showable_if:
      <<: *enabled_if
      all:
        this:
          prev_activity_type: ''

    editable_if: *enabled_if

    save_trigger:
      on_create:
        notify:
          - *notify_ps_checklist_initiator
          - *notify_baseline_checklist_initiator
          - *notify_reviewer
          - *notify_pi
          - *notify_tms


  ps_contact_references: &ps_contact_references

  - activity_log__ipa_assignment_inex_checklist:
      label: Contact
      from: this
      creatable_if:
        never: true

  - activity_log__ipa_assignment_inex_checklist:
      label: Contact Staff Member
      from: this
      add: one_to_this
      add_with:
        extra_log_type: ps_contact_creator
        prev_activity_type: ps_contact_creator
      filter_by:
        extra_log_type: show none

  - activity_log__ipa_assignment_inex_checklist:
      label: Contact MedNav
      from: this
      add: one_to_this
      add_with:
        extra_log_type: ps_contact_reviewer
        prev_activity_type: ps_contact_creator
      filter_by:
        extra_log_type: show none

  - activity_log__ipa_assignment_inex_checklist:
      label: Contact PI
      from: this
      add: one_to_this
      add_with:
        extra_log_type: contact_pi
        prev_activity_type: ps_contact_creator
      filter_by:
        extra_log_type: show none



_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if

####
# Phone Screen Review - checklist
# Remains editable until PI has signed it
####
phone_screen_review:
  label: Fill Phone Screen Review

  references:
    ipa_inex_checklist:
      from: this
      add: one_to_this
      filter_by:
        fixed_checklist_type: phone screen review
  caption_before:
    all_fields: |
      Edit to review and correct the checklist.
      <i>Note: form changes are not saved until all fields are validated as being completed.
      When Save is clicked you will be warned if any fields are not set. If necessary, set any that are blank and save again.</i>

  # This activity is always created automatically by the completion of the
  # phone screen being finalized
  creatable_if:
    never: true
  # Editable until the PI has signed
  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
  view_options:
    show_embedded_at_top: true

  save_action:
    on_create: create_next_creatable

####
# ADL Informant Screener - only if needed
####
adl_informant_screener:
  label: ADL Informant Screener
  references:
    dynamic_model__ipa_adl_informant_screener:
      from: master
      view_as:
        new: readonly
        edit: readonly
  caption_before:
    all_fields: Results of the Phone Screen T-MoCA indicate an ADL Informant Screener must be filled out. If the ADL Informant Screener has been received it will be shown after saving this item.

  # We expect the informant screener activity to be created automatically during
  # creation of the phone screen checklist (if necessary).
  # For now, keep this as a placeholder to ensure the user is prompted if
  # the appropriate trigger has not been updated
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
    all_2:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: informant_details
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: adl_informant_screener
  editable_if:
    never: true

  showable_if:
    <<: *enabled_if
    all_adl:
      dynamic_model__ipa_inex_checklists:
        fixed_checklist_type: phone screen review
        ix_tmoca_score_blank_yes_no: 'yes'

####
# Staff Member Signs Phone Screen checklist
####
sign_phone_screen_staff:
  label: Sign Phone Screen Review (Staff)
  fields:
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

    any:
      not_any:
        activity_log__ipa_assignment_phone_screens:
          extra_log_type: informant_details
      all:
        activity_log__ipa_assignment_phone_screens:
          extra_log_type: informant_details
        activity_log__ipa_assignment_inex_checklists:
          extra_log_type: adl_informant_screener

  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_phone_screen_staff
              signed_no_yes: "yes"

  # Notify the Reviewer that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        <<: *notify_reviewer
        subject: "IPA App: Inclusion / Exclusion checklist needs review"
        if:
          all:
            this:
              signed_no_yes: 'yes'


####
# Reviewer Signs Phone Screen checklist
####
sign_phone_screen_reviewer:
  label: Sign Phone Screen Review (Reviewer)
  fields:
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Review the checklist. When ready, sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_reviewer
        signed_no_yes: "yes"

    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"


  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_reviewer
        signed_no_yes: "yes"

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_phone_screen_reviewer
              signed_no_yes: "yes"

  # Notify the PI that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        <<: *notify_pi
        subject: "IPA App: Inclusion / Exclusion checklist needs review"
        if:
          all:
            this:
              signed_no_yes: 'yes'




####
# PI Signs Phone Screen checklist
# This has the side-effect of locking the checklist to prevent further edits
# The creator of the checklist is notified at this point
####
sign_phone_screen:
  label: Sign Phone Screen Review (PI)
  fields:
    - select_subject_eligibility
    - notes
    - signed_no_yes
  caption_before:
    all_fields: "Review the checklist and confirm the subject's eligibility. When ready, select the subject's eligibility and sign the checklist by selecting <b>yes</b> in the <b>signed</b> field."
  creatable_if:
    <<: *enabled_if

    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_reviewer
        signed_no_yes: "yes"

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"

  save_trigger:
    on_create:
      notify:
        <<: *notify_ps_checklist_initiator
        subject: "IPA App: Inclusion / Exclusion checklist signed by PI"
        if:
          all:
            this:
              signed_no_yes: 'yes'





####
# TMS Review
####
tms_responses:
  label: TMS Responses
  references:
    dynamic_model__ipa_tms_review:
      from: any
      view_as:
        new: readonly
        edit: readonly
  caption_before:
    all_fields: TMS responses from the participant's Phone Screener

  # We expect the TMS Responses activity to be created automatically during
  # creation of the phone screen checklist.
  # For now, keep this as a placeholder to ensure the user is prompted if
  # the appropriate trigger has not been updated
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: tms_responses
  editable_if:
    never: true



####
# TMS Signs TMS eligibility
####
sign_tms_eligibility:
  label: TMS Eligibility
  fields:
    - select_subject_eligibility
    - notes
    - signed_no_yes


  field_options:
    select_subject_eligibility:
      edit_as:
        alt_options:
          - eligible for TMS
          - not eligible for TMS


  caption_before:
    all_fields: |
      Review the participant's responses for TMS eligibility.
      When ready, select the eligibility and sign your decision by selecting <b>yes</b> in the <b>signed</b> field.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: tms_responses

    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_tms_eligibility
        signed_no_yes: "yes"

  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_tms_eligibility
        signed_no_yes: "yes"

  # Notify the Reviewer that the TMS decision has been signed
  save_trigger:
    on_save:
      notify:
        <<: *notify_reviewer
        subject: "IPA App: TMS eligibility review completed"
        if:
          all:
            this:
              signed_no_yes: 'yes'




####
# Baseline review - checklist
# Remains editable until PI has signed it
####
baseline_review:
  label: Fill Baseline Review

  references:
    ipa_inex_checklist:
      from: this
      add: one_to_this
      filter_by:
        fixed_checklist_type: baseline review
  caption_before:
    all_fields: Fill out the checklist.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"

  view_options:
    show_embedded_at_top: true

  save_action:
    on_create: create_next_creatable



####
# Staff Member Signs Baseline checklist
####
sign_baseline_staff:
  label: Sign Baseline Review (Staff)
  fields:
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_baseline_staff
              signed_no_yes: "yes"

  # Notify the PI that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        <<: *notify_pi
        subject: "IPA App: Inclusion / Exclusion checklist needs review"
        if:
          all:
            this:
              signed_no_yes: 'yes'


####
# PI Signs Baseline checklist
# This has the side-effect of locking the checklist to prevent further edits
####
sign_baseline:
  label: Sign Baseline Review (PI)
  fields:
    - select_subject_eligibility
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Select the subject's eligibility and sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"



  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"

##########################################

####
# Phone Screen checklist review -
# contact staff member that completed the phone screener
####
ps_contact_creator:
  label: Contact Staff Member

  <<: *contact_defaults
  references: *ps_contact_references

  save_action:
    label: Send to Staff Member
  caption_before:
    notes: |
      Use this activity to contact the original staff member about the phone screen checklist.
      Note: messages are visible to all phone screen checklist users.
    submit: After clicking <i>Send</i> the staff member will be notified.


  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review



####
# Phone Screen checklist review -
# contact MedNav reviewer
####
ps_contact_reviewer:
  label: Contact MedNav re Checklist

  <<: *contact_defaults
  references: *ps_contact_references

  save_action:
    label: Send to Reviewer
  caption_before:
    notes: |
      Use this activity to contact the reviewer about the phone screen checklist.
      Note: messages are visible to all phone screen checklist users.
    submit: After clicking <i>Send</i> the reviewer will be notified.

  save_trigger:
    on_create:
      notify:
        <<: *notify_reviewer

  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review



####
# Phone Screen checklist review -
# contact PI
####
contact_pi:
  label: Contact PI re Checklist

  <<: *contact_defaults
  references: *ps_contact_references

  save_action:
    label: Send to PI
  caption_before:
    notes: |
      Use this activity to contact the PI about the the phone screen checklist.
      Note: messages are visible to all phone screen checklist users.
    submit: After clicking <i>Send</i> the PI will be notified.
  save_trigger:
    on_create:
      notify:
        <<: *notify_pi
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review


####
# Baseline checklist review -
# contact navigator that created the baseline checklist
####
baseline_contact_creator:
  label: Contact Navigator
  fields:
    - notes
  save_action:
    label: Send to Navigator
  caption_before:
    notes: |
      Use this activity to contact the navigator about the baseline checklist.
      Note: messages are visible to all baseline checklist users.
    submit: After clicking <i>Send</i> the staff member will be notified.

  save_trigger:
    on_create:
      notify:
        <<: *notify_baseline_checklist_initiator

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review


####
# Baseline checklist review -
# contact PI
####
baseline_contact_pi:
  label: Contact PI re Checklist
  fields:
    - notes
  save_action:
    label: Send to PI
  caption_before:
    notes: |
      Use this activity to contact the PI about the the baseline checklist.
      Note: messages are visible to all baseline checklist users.
    submit: After clicking <i>Send</i> the PI will be notified.
  save_trigger:
    on_create:
      notify:
        <<: *notify_pi
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

####
# TMS review process -
# MedNav Reviewer or PI contact TMS group
####
tms_contact_tms:
  label: Contact TMS
  fields:
    - notes
  save_action:
    label: Send to TMS
  caption_before:
    notes: |
      Use this activity to contact the TMS group about the TMS eligibility review.
      Enter the message to send.
    submit: After clicking <i>Send</i> the TMS group will be notified.

  save_trigger:
    on_create:
      notify:
        <<: *notify_tms

  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review


####
# TMS review process -
# contact PI
####
tms_contact_pi:
  label: Contact PI re TMS
  fields:
    - notes
  save_action:
    label: Send to PI
  caption_before:
    notes: |
      Use this activity to contact the PI about the the TMS review.
      Note: messages are visible to all TMS review users.
    submit: After clicking <i>Send</i> the PI will be notified.
  save_trigger:
    on_create:
      notify:
        <<: *notify_pi
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review


####
# TMS review -
# contact MedNav reviewer
####
tms_contact_reviewer:
  label: Contact MedNav re TMS
  fields:
    - notes
  save_action:
    label: Send to MedNav
  caption_before:
    notes: |
      Use this activity to contact the MedNav reviewer about the TMS review.
      Note: messages are visible to all TMS review users.
    submit: After clicking <i>Send</i> the reviewer will be notified.

  save_trigger:
    on_create:
      notify:
        <<: *notify_reviewer

  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review




##########################
supporting_files:
  label: Supporting Files

  fields:
    - notes

  caption_before:
    notes: Describe the files in this container. Individual files can also be given a title and description in the file classifications.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review

  editable_if:
    <<: *enabled_if

  save_trigger:
    on_create:
      <<: *create_filestore_container

  references:
    nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container

notes:
  label: Notes
  fields:
    - notes

  caption_before:
    notes: Record notes and observations to support decisions or to assist in later reviews. The entry will editable until another log entry is made.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review

  editable_if:
  # lock the item when the next log is added by making editable_if null
