_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  # Boilerplate for notifying the staff member that initiated the phone screen checklist
  # Override the subject: and if: structures to refine operation
  notify_ps_checklist_initiator: &notify_ps_checklist_initiator
    type: email
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
        user_id: return_value

  # Boilerplate for notifying the staff member that initiated the baseline checklist
  # Override the subject: and if: structures to refine operation
  notify_baseline_checklist_initiator: &notify_baseline_checklist_initiator
    type: email
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review
        user_id: return_value


  notify_pi: &notify_pi
    type: email
    role: email - inex pi
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: supporting documents
        label: Supporting Documents
        create_with_role: nfs_store group 600



_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if


phone_screen_review:
  label: Fill Phone Screen Review

  references:
    ipa_inex_checklist:
      from: this
      add: one_to_this
      filter_by:
        fixed_checklist_type: phone screen review
  caption_before:
    all_fields: Edit to review and correct the checklist.
  creatable_if:
    never: true
  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
  view_options:
    show_embedded_at_top: true

  save_action:
    on_create: create_next_creatable


adl_informant_screener:
  label: ADL Informant Screener
  references:
    dynamic_model__ipa_adl_informant_screener:
      from: master
      view_as:
        new: readonly
        edit: readonly
  caption_before:
    all_fields: Results of the Phone Screen T-MoCA indicate an ADL Informant Screener must be filled out. If the ADL Informant Screener has been received it will be shown after saving this item.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
    all_2:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: informant_details
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: adl_informant_screener
  editable_if:
    never: true

  # save_action:
    # on_create: create_next_creatable


sign_phone_screen_staff:
  label: Sign Phone Screen Review (Staff)
  fields:
    - signed_no_yes
  caption_before:
    all_fields: Sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

    any:
      not_any:
        activity_log__ipa_assignment_phone_screens:
          extra_log_type: informant_details
      all:
        activity_log__ipa_assignment_phone_screens:
          extra_log_type: informant_details
        activity_log__ipa_assignment_inex_checklists:
          extra_log_type: adl_informant_screener

  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_phone_screen_staff
              signed_no_yes: "yes"

  # Notify the PI that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        <<: *notify_pi
        subject: "IPA App: Inclusion / Exclusion checklist needs review"
        if:
          all:
            this:
              signed_no_yes: 'yes'



sign_phone_screen:
  label: Sign Phone Screen Review (PI)
  fields:
    - select_subject_eligibility
    - signed_no_yes
  caption_before:
    all_fields: Select the subject's eligibility and sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if

    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"




baseline_review:
  label: Fill Baseline Review

  references:
    ipa_inex_checklist:
      from: this
      add: one_to_this
      filter_by:
        fixed_checklist_type: baseline review
  caption_before:
    all_fields: Fill out the checklist.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"

  view_options:
    show_embedded_at_top: true

  save_action:
    on_create: create_next_creatable



#
sign_baseline_staff:
  label: Sign Baseline Review (Staff)
  fields:
    - signed_no_yes
  caption_before:
    all_fields: Sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_baseline_staff
              signed_no_yes: "yes"

  # Notify the PI that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        <<: *notify_pi
        subject: "IPA App: Inclusion / Exclusion checklist needs review"
        if:
          all:
            this:
              signed_no_yes: 'yes'


sign_baseline:
  label: Sign Baseline Review (PI)
  fields:
    - select_subject_eligibility
    - signed_no_yes
  caption_before:
    all_fields: Select the subject's eligibility and sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"



  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"



#
ps_contact_creator:
  label: Contact Staff Member
  fields:
    - notes
  save_action:
    label: Send to Staff Member
  caption_before:
    notes: |
      Use this activity to contact the original staff member about the phone screen checklist.
      Enter the message to send to the staff member that created the phone screen checklist.
    submit: After clicking <i>Send</i> the staff member will be notified.

  save_trigger:
    on_save:
      notify:
        <<: *notify_ps_checklist_initiator

  creatable_if:
    <<: *enabled_if


#
baseline_contact_creator:
  label: Contact Navigator
  fields:
    - notes
  save_action:
    label: Send to Navigator
  caption_before:
    notes: |
      Use this activity to contact the navigator about the baseline checklist.
      Enter the message to send to the navigator that created the baseline checklist.
    submit: After clicking <i>Send</i> the staff member will be notified.

  save_trigger:
    on_save:
      notify:
        <<: *notify_baseline_checklist_initiator

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review


#
contact_pi:
  label: Contact PI
  fields:
    - notes
  save_action:
    label: Send to PI
  caption_before:
    notes: |
      Use this activity to contact the PI about the inclusion / exclusion checklists.
      Enter the message.
    submit: After clicking <i>Send</i> the PI will be notified.
  save_trigger:
    on_save:
      notify:
        <<: *notify_pi
  creatable_if:
    <<: *enabled_if

#

supporting_files:
  label: Supporting Files

  fields:
    - notes

  caption_before:
    notes: Describe the files in this container. Individual files can also be given a title and description in the file classifications.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review

  editable_if:
    <<: *enabled_if

  save_trigger:
    on_create:
      <<: *create_filestore_container

  references:
    nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container

notes:
  label: Notes
  fields:
    - notes

  caption_before:
    notes: Record notes and observations to support decisions or to assist in later reviews. The entry will editable until another log entry is made.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review

  editable_if:
  # lock the item when the next log is added by making editable_if null
