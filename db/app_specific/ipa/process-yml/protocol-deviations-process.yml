# @library ipa enabled_if

_definitions:

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: event documents
        label: Event Documents
        create_with_role: nfs_store group 600



_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if


  view_options:
    hide_unless_creatable: true,
    always_embed_reference: dynamic_model__ipa_protocol_deviation

exception_record:
  label: Protocol Exception

  references:

  # Always show the record that contains event details
  - dynamic_model__ipa_protocol_exception:
      from: this
      add: one_to_this


deviation_record:
  label: Protocol Deviation
  fields:

  editable_if:
    not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: pi_review
            id:
              this_references: id

  save_trigger:
    on_create:
      <<: *create_filestore_container

      notify:
      - type: email
        role: email - protocol deviation review
        layout_template: ipa notification layout
        content_template: ipa protocol deviation message
        subject: "IPA App: Protocol Deviation needs initial review"
      - type: sms
        role: sms - protocol deviation review
        layout_template: standard sms layout
        content_template: ipa sms notification
        subject: Protocol Deviation

  references:

  # Always show the record that contains event details
  - dynamic_model__ipa_protocol_deviation:
      from: this
      add: one_to_this

  # The initial review can be performed at any time until the PI review has been completed
  # It does not block PI review
  - activity_log__ipa_assignment_protocol_deviation:
      label: Initial Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: initial_review
      filter_by:
        extra_log_type: initial_review

      creatable_if:
        all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: deviation_record
            id:
              this: id

        not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: pi_review
            id:
              this_references: id

  # The PI review can be performed at any time until the event is reported to the IRB
  # It is not blocked by initial review and can happen in place of it
  # The rules around which type of events need PI review still stand, but are not enforced
  # here, since the PI may select to just handle the items before initial review has classified them
  - activity_log__ipa_assignment_protocol_deviation:
      label: PI Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: pi_review
      filter_by:
        extra_log_type: pi_review
      creatable_if:
        all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: deviation_record
            id:
              this: id

        not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: report_to_irb
            id:
              this_references: id


  - activity_log__ipa_assignment_protocol_deviation:
      label: Report to IRB
      from: this
      add: one_to_this
      add_with:
        extra_log_type: report_to_irb
      filter_by:
        extra_log_type: report_to_irb
      creatable_if:
        all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: pi_review
            id:
              this_references: id
          dynamic_model__ipa_protocol_deviations:
            select_severity: major
            id:
              this_references: id
        not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: report_to_irb
            id:
              this_references: id

  - nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container



initial_review:
  label: Completed Initial Review

  fields:
    - select_who
    - done_when
    - notes

  caption_before:
    all_fields: <b>Review the protocol deviation and update the details and severity if necessary before continuing.</b>
    select_who: Who performed this review (if recording this action for somebody else)?
    done_when: When was this task performed?
    submit: Review the protocol deviation and update the details and severity if necessary. When complete, click <b>Complete</b>. If the <i>severity</i> is <b>Major</b>, the PI will be notified.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
  save_trigger:
    on_create:
      notify:
      - type: email
        role: email - protocol deviation pi
        layout_template: ipa notification layout
        content_template: ipa protocol deviation message
        subject: "IPA App: Protocol Deviation needs review"
        if: &notify_conditions_pi
          all:
            dynamic_model__ipa_protocol_deviations:
              select_severity: major
              id:
                parent_references: id

      - type: sms
        role: sms - protocol deviation pi
        layout_template: standard sms layout
        content_template: ipa sms notification
        subject: Protocol Deviation
        if: *notify_conditions_pi

pi_review:
  label: Complete PI Review
  fields:
    - select_who
    - done_when
    - notes

  caption_before:
    all_fields: <b>Review the protocol deviation and update the details and severity if necessary before continuing.</b>
    select_who: Who performed this review (if recording this action for somebody else)?
    done_when: When was this task performed?
    submit: Review the protocol deviation. When complete, click <b>Complete</b>. If the <i>severity</i> is <b>Major</b>, a staff member will be notified and will complete the report for the IRB.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true

  save_trigger:
    on_create:
      notify:
      - type: email
        role: email - protocol deviation irb report
        layout_template: ipa notification layout
        content_template: ipa protocol deviation message
        subject: "IPA App: Protocol Deviation needs IRB report"
        if: &notify_conditions_irb_report
          all:
            dynamic_model__ipa_protocol_deviations:
              select_severity: major
              id:
                parent_references: id

      - type: sms
        role: sms - protocol deviation irb report
        layout_template: standard sms layout
        content_template: ipa sms notification
        subject: Protocol Deviation
        if: *notify_conditions_irb_report


report_to_irb:
  label: Completed Report to IRB
  fields:
    - select_who
    - done_when
    - notes

  caption_before:
    select_who: Who performed the task (if recording this action for somebody else)?
    done_when: When was this task performed?
    submit: When the major protocol deviation has been reported to the IRB, click <b>Complete</b>.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
