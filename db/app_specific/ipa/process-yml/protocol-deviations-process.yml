_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: event documents
        label: Event Documents
        create_with_role: nfs_store group 600



_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if

  view_options:
    hide_unless_creatable: true,
    always_embed_reference: dynamic_model__ipa_protocol_deviation

deviation_record:
  label: Protocol Deviation
  fields:

  editable_if:
    not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: pi_review
            id:
              this_references: id

  save_trigger:
    on_create:
      <<: *create_filestore_container

      notify:
        type: email
        role: clinical research coordinator
        layout_template: ipa notification layout
        content_template: ipa protocol deviation message
        subject: "IPA App: Protocol Deviation needs initial review"


  references:
  - dynamic_model__ipa_protocol_deviation:
      from: this
      add: one_to_this

  - activity_log__ipa_assignment_protocol_deviation:
      label: Initial Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: initial_review
      filter_by:
        extra_log_type: initial_review

      creatable_if:
        all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: deviation_record
            id:
              this: id
        not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: initial_review
            id:
              this: id

  - activity_log__ipa_assignment_protocol_deviation:
      label: PI Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: pi_review
      filter_by:
        extra_log_type: pi_review
      creatable_if:
        all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: initial_review
            id:
              this_references: id
          dynamic_model__ipa_protocol_deviations:
            select_severity: major
            id:
              this_references: id
        not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: pi_review
            id:
              this_references: id

  - activity_log__ipa_assignment_protocol_deviation:
      label: Report to IRB
      from: this
      add: one_to_this
      add_with:
        extra_log_type: report_to_irb
      filter_by:
        extra_log_type: report_to_irb
      creatable_if:
        all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: pi_review
            id:
              this_references: id
          dynamic_model__ipa_protocol_deviations:
            select_severity: major
            id:
              this_references: id
        not_all:
          activity_log__ipa_assignment_protocol_deviations:
            extra_log_type: report_to_irb
            id:
              this_references: id

  - nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container



initial_review:
  label: Completed Initial Review
  caption_before:
    submit: Review the protocol deviation and update the details and severity if necessary. When complete, click <b>Complete</b>. If the <i>severity</i> is <b>Major</b>, the PI will be notified.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
  save_trigger:
    on_create:
      notify:
        type: email
        role: pi
        layout_template: ipa notification layout
        content_template: ipa protocol deviation message
        subject: "IPA App: Protocol Deviation needs review"
        if:
          all:
            dynamic_model__ipa_protocol_deviations:
              select_severity: major
              id:
                parent_references: id

pi_review:
  label: Complete PI Review
  caption_before:
    submit: Review the protocol deviation. When complete, click <b>Complete</b>. If the <i>severity</i> is <b>Major</b>, a staff member will be notified and will complete the report for the IRB.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true

  save_trigger:
    on_create:
      notify:
        type: email
        role: clinical research coordinator
        layout_template: ipa notification layout
        content_template: ipa protocol deviation message
        subject: "IPA App: Protocol Deviation needs IRB report"
        if:
          all:
            dynamic_model__ipa_protocol_deviations:
              select_severity: major
              id:
                parent_references: id


report_to_irb:
  label: Completed Report to IRB
  caption_before:
    submit: When the major protocol deviation has been reported to the IRB, click <b>Complete</b>.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
