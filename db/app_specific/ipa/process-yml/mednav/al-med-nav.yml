_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container:
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: general files
        label: General Files
        create_with_role: nfs_store group 600


######################

  followup_fields: &followup_fields
    - activity_date
    - select_direction
    - select_contact
    - select_result
    - select_next_step
    - follow_up_when
    - follow_up_time


  communication_fields: &communication_fields
    - select_activity
    - activity_date
    - select_contact
    - select_direction
    - select_result
    - select_next_step
    - follow_up_when
    - follow_up_time

  communication_show_if: &communication_show_if
    select_result:
      not_any:
        select_activity:
          - schedule follow up
          - completed
    select_next_step:
      any:
        select_result: follow up
        select_activity: schedule follow up
    follow_up_when:
      any:
        select_result: follow up
        select_activity: schedule follow up
    follow_up_time:
      any:
        select_result: follow up
        select_activity: schedule follow up
    select_direction:
      not_any:
        select_activity:
          - schedule follow up
          - completed
    select_contact:
      not_any:
        select_activity:
          - completed

        select_direction:
          - in person

  communication_field_options: &communication_field_options
    select_result:
      edit_as:
        alt_options:
          "Completed": completed
          "Follow up": follow up
    select_next_step:
      edit_as:
        alt_options:
          # "More Info Requested": more info requested
          # "No Follow Up": no follow up
          "Call Back": call back
          "Email Back": email back


    select_contact:
      edit_as:
        field_type: select_record_from_player_contacts

    select_activity:
      edit_as:
        alt_options:
          "General Communications": general communications
          "Incidental Finding": incidental finding
          "Schedule Follow Up": schedule follow up
          "Mark All Previous As Completed": completed

    select_direction:
      edit_as:
        alt_options:
          "In Person": in person
          "By Phone": by phone


  communication_caption_before: &communication_caption_before
    select_activity: Select an action
    activity_date: Date
    select_contact: Phone or email address
    select_direction: Was the follow-up / interview performed in person or by phone?
    select_result: Is a follow up required, or is this communication complete?


_default:
  fields: *communication_fields

  show_if:
    <<: *communication_show_if

  field_options:
    <<: *communication_field_options

  caption_before:
    <<: *communication_caption_before

  view_options:
    hide_unless_creatable: true

  showable_if: *enabled_if
  creatable_if: *enabled_if
  editable_if: *enabled_if



#################################################
exit_interview:
  label: Exit Interview
#################################################

  fields: *followup_fields

  references:
    dynamic_model__ipa_exit_interview:
      from: this
      add: one_to_this



#################################################
two_wk_followup:
  label: Two Week Follow Up
#################################################

  fields: *followup_fields

  references:
    dynamic_model__ipa_two_wk_followup:
      from: this
      add: one_to_this

#################################################
four_wk_followup:
  label: Four Week Follow Up
#################################################

  fields: *followup_fields

  references:
    dynamic_model__ipa_four_wk_followup:
      from: this
      add: one_to_this


#################################################
participant_communication:
  label: Participant Communication
#################################################

  references:
    dynamic_model__ipa_mednav_followup:
      from: this
      add: one_to_this
      prevent_disable: true

  caption_before:
    <<: *communication_caption_before
    select_direction: Was the communication received by FPHS staff or sent to the subject?


  field_options:
    <<: *communication_field_options
    select_direction:
      edit_as:
        alt_options:
          "To Staff": to staff
          "To Subject": to subject



#################################################
provider_communication:
  label: Provider Communication
#################################################

  references:
    dynamic_model__ipa_mednav_provider_comm:
      from: this
      add: one_to_this
      prevent_disable: true


  field_options:
    <<: *communication_field_options
    select_activity:
      edit_as:
        alt_options:
          "General Communications": general communications
          "Schedule Follow Up": schedule follow up
          "Mark All Previous As Completed": completed
    select_direction:
      edit_as:
        alt_options:
          "To Staff": to staff
          "To Provider": to provider

    select_contact:
      edit_as:
        field_type: contact



  caption_before:
    select_activity: Select an action
    activity_date: Date
    select_contact: Provider name
    select_direction: Was the communication received by FPHS staff or directed to the provider?
    select_result: Is a follow up required, or is this communication complete?


#################################################
provider_report:
  label: Provider Report
#################################################

  fields:
    - activity_date
    - select_contact
    - select_direction


  references:
    dynamic_model__ipa_mednav_provider_report:
      from: this
      add: one_to_this
      prevent_disable: true

  field_options:
    <<: *communication_field_options
    select_activity:
      value: Sent report to provider
    select_contact:
      edit_as:
        field_type: contact
    select_direction:
      edit_as:
        alt_options:
          Mail: mail
          Fax: fax
          Epic: epic



  caption_before:
    activity_date: Date sent
    select_contact: Provider name
    select_direction: Method sent


#################################################
incidental_findings:
  label: Incidental Findings
#################################################

  fields:

  references:
    dynamic_model__ipa_incidental_finding:
      from: this
      add: one_to_this
      prevent_disable: true

  creatable_if:
    <<: *enabled_if
    not_any:
      activity_log__ipa_assignment_med_navs:
        extra_log_type: incidental_findings

  view_options:
    hide_unless_creatable: false


#################################################
files:
  label: Files
#################################################

  fields:
    - notes

  caption_before:
    notes: Notes
    submit: Save to create a container for files

  save_trigger:
    on_create:
      <<: *create_filestore_container

  references:
    <<: *ref_filestore_container
