_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container:
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: general files
        label: General Files
        create_with_role: nfs_store group 600


######################

  communication_fields: &communication_fields
    - select_activity
    - activity_date
    - select_contact
    - select_direction
    - select_result
    - select_next_step
    - follow_up_when
    - follow_up_time

  communication_show_if: &communication_show_if
    select_result:
      not_any:
        select_activity:
          - schedule follow up
          - completed
    select_next_step:
      any:
        select_result: follow up
        select_activity: schedule follow up
    follow_up_when:
      any:
        select_result: follow up
        select_activity: schedule follow up
    follow_up_time:
      any:
        select_result: follow up
        select_activity: schedule follow up
    select_direction:
      not_any:
        select_activity:
          - schedule follow up
          - completed
    select_contact:
      not_any:
        select_activity:
          - completed


  communication_field_options: &communication_field_options
    select_result:
      edit_as:
        alt_options:
          "Completed": completed
          "Follow up": follow up
    select_next_step:
      edit_as:
        alt_options:
          "More Info Requested": more info requested
          "No Follow Up": no follow up
          "Email Back": email back
          "Call Back": call back



_default:
  view_options:
    hide_unless_creatable: true

  showable_if: *enabled_if
  creatable_if: *enabled_if
  editable_if: *enabled_if




exit_interview:
  label: Exit Interview
  references:
    dynamic_model__ipa_exit_interview:
      from: this
      add: one_to_this


two_wk_followup:
  label: Two Week Follow Up
  references:
    dynamic_model__ipa_two_wk_followup:
      from: this
      add: one_to_this

four_wk_followup:
  label: Four Week Follow Up
  references:
    dynamic_model__ipa_four_wk_followup:
      from: this
      add: one_to_this


#################################################
participant_communication:
  label: Participant Communication
#################################################

  fields: *communication_fields

  show_if:
    <<: *communication_show_if

  references:
    dynamic_model__ipa_mednav_followup:
      from: this
      add: one_to_this
      prevent_disable: true

  field_options:
    <<: *communication_field_options
    select_contact:
      edit_as:
        field_type: select_record_from_player_contacts

    select_activity:
      edit_as:
        alt_options:
          "General Communications": general communications
          "Incidental Finding": incidental finding
          "Schedule Follow Up": schedule follow up
          "Mark All Previous As Completed": completed
    select_direction:
      edit_as:
        alt_options:
          "To Staff": to staff
          "To Subject": to subject

  caption_before:
    select_activity: Select an action:<ul><li>record a general communication</li><li>record an incidental finding call</li><li>schedule a follow up</li><li>mark all previous follow-ups completed</li></ul>
    activity_date: Date
    select_contact: The phone or email address
    select_direction: Was the communication received by FPHS staff or sent to the subject?
    select_result: Is a follow up required, or is this communication complete?


#################################################
provider_communication:
  label: Provider Communication
#################################################

  fields: *communication_fields

  show_if:
    <<: *communication_show_if

  references:
    dynamic_model__ipa_mednav_provider_contact:
      from: this
      add: one_to_this
      prevent_disable: true


  field_options:
    <<: *communication_field_options
    select_activity:
      edit_as:
        alt_options:
          "General Communications": general communications
          "Schedule Follow Up": schedule follow up
          "Mark All Previous As Completed": completed
    select_direction:
      edit_as:
        alt_options:
          "To Staff": to staff
          "To Subject": to provider

  caption_before:
    select_activity: Select an action
    activity_date: Date
    select_contact: Provider name
    select_direction: Was the communication received by FPHS staff or to the provider?
    select_result: Is a follow up required, or is this communication complete?


#################################################
provider_report:
  label: Provider Report
#################################################

  fields:
    - select_activity
    - activity_date
    - select_contact
    - select_result
    - select_next_step
    - follow_up_when
    - follow_up_time

  show_if:
    <<: *communication_show_if

  field_options:
    <<: *communication_field_options
    select_activity:
      value: Sent report to provider


  caption_before:
    select_activity: Action
    activity_date: Date
    select_contact: Provider name
    # select_result: Is a follow up required, or is this communication complete?


#################################################
files:
  label: Files
#################################################

  save_trigger:
    on_create:
      <<: *create_filestore_container

  references:
    <<: *ref_filestore_container
