_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  ####
  # Boilerplace for notifying roles
  # Override the subject: and if: structures to refine operation
  ####

  # Default email - just add roles or users
  notify_email_default: &notify_email_default
    type: email
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Inclusion / Exclusion checklist message"

  # Default SMS - just add roles or users
  notify_sms_default: &notify_sms_default
    type: sms
    layout_template: standard sms layout
    content_template: ipa sms notification
    subject: "Inclusion / Exclusion"


  # staff member that initiated the phone screen checklist
  notify_ps_checklist_initiator: &notify_ps_checklist_initiator
    <<: *notify_email_default
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
        user_id: return_value

  # staff member that initiated the phone screen checklist SMS
  notify_ps_checklist_initiator_sms: &notify_ps_checklist_initiator_sms
    <<: *notify_sms_default
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
        user_id: return_value


  # staff member that initiated the baseline checklist
  notify_baseline_checklist_initiator: &notify_baseline_checklist_initiator
    <<: *notify_email_default
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review
        user_id: return_value


  # staff member that initiated the phone screen checklist SMS
  notify_baseline_checklist_initiator_sms: &notify_baseline_checklist_initiator_sms
    <<: *notify_sms_default
    users:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review
        user_id: return_value


  # MedNav reviewer
  notify_reviewer: &notify_reviewer
    <<: *notify_email_default
    role: email - inex reviewer

  # MedNav reviewer SMS
  notify_reviewer_sms: &notify_reviewer_sms
    <<: *notify_sms_default
    role: sms - inex reviewer

  # MedNav reviewer checklist ready
  notify_reviewer_checklist_ready: &notify_reviewer_checklist_ready
    <<: *notify_reviewer
    if:
      all:
        this:
          signed_no_yes: 'yes'

  # MedNav reviewer SMS checklist ready
  notify_reviewer_sms_checklist_ready: &notify_reviewer_sms_checklist_ready
    <<: *notify_reviewer_sms
    if:
      all:
        this:
          signed_no_yes: 'yes'


  # PI
  notify_pi: &notify_pi
    <<: *notify_email_default
    role: email - inex pi

  # PI checklist ready
  notify_pi_checklist_ready: &notify_pi_checklist_ready
    <<: *notify_pi
    if:
      all:
        this:
          signed_no_yes: 'yes'

  # PI SMS
  notify_pi_sms: &notify_pi_sms
    <<: *notify_sms_default
    role: sms - inex pi


  # PI SMS checklist ready
  notify_pi_sms_checklist_ready: &notify_pi_sms_checklist_ready
    <<: *notify_pi_sms
    if:
      all:
        this:
          signed_no_yes: 'yes'


  # TMS group
  notify_tms: &notify_tms
    <<: *notify_email_default
    role: email - inex tms


    # TMS group SMS
  notify_tms_sms: &notify_tms_sms
    <<: *notify_sms_default
    role: sms - inex tms


  ####
  # Handle options for generic contact forms, allowing a
  # drop-down to select which role or user is notified
  ####

  notify_ps_checklist_initiator_option: &notify_ps_checklist_initiator_option
    <<: *notify_ps_checklist_initiator
    if:
      all:
        this:
          contact_role: staff member

  notify_ps_checklist_initiator_option_sms: &notify_ps_checklist_initiator_option_sms
    <<: *notify_ps_checklist_initiator_sms
    if:
      all:
        this:
          contact_role: staff member


  notify_baseline_checklist_initiator_option: &notify_baseline_checklist_initiator_option
    <<: *notify_baseline_checklist_initiator
    if:
      all:
        this:
          contact_role: baseline initiator

  notify_baseline_checklist_initiator_option_sms: &notify_baseline_checklist_initiator_option_sms
    <<: *notify_baseline_checklist_initiator_sms
    if:
      all:
        this:
          contact_role: baseline initiator


  notify_reviewer_option: &notify_reviewer_option
    <<: *notify_reviewer
    if:
      all:
        this:
          contact_role: mednav reviewer

  notify_reviewer_option_sms: &notify_reviewer_option_sms
    <<: *notify_reviewer_sms
    if:
      all:
        this:
          contact_role: mednav reviewer


  notify_pi_option: &notify_pi_option
    <<: *notify_pi
    if:
      all:
        this:
          contact_role: pi

  notify_pi_option_sms: &notify_pi_option_sms
    <<: *notify_pi_sms
    if:
      all:
        this:
          contact_role: pi


  notify_tms_option: &notify_tms_option
    <<: *notify_tms
    if:
      all:
        this:
          contact_role: tms

  notify_tms_option_sms: &notify_tms_option_sms
    <<: *notify_tms_sms
    if:
      all:
        this:
          contact_role: tms


  ####
  # Filestore Reference
  ####
  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: supporting documents
        label: Supporting Documents
        create_with_role: nfs_store group 600


  ####
  # Contact defaults for all generic contact forms
  ####
  contact_defaults: &contact_defaults
    fields:
      - contact_role
      - notes
      - prev_activity_type

    valid_if:
      on_save:
        not_any:
          this:
            contact_role: ''

    labels:
      select_contact: notify role
      contact_role: notify role

    show_if:
      prev_activity_type:
        never: true

    view_options:
      data_attribute:
        - "to:"
        - contact_role
        - ":"
        - notes

    showable_if:
      <<: *enabled_if
      all:
        this:
          prev_activity_type: ''

    editable_if:
      <<: *enabled_if
      all:
        this:
          prev_activity_type: ''


    save_action:
      label: Send

    save_trigger:
      on_create:
        notify:
          - *notify_ps_checklist_initiator_option
          - *notify_baseline_checklist_initiator_option
          - *notify_reviewer_option
          - *notify_pi_option
          - *notify_tms_option
          - *notify_ps_checklist_initiator_option_sms
          - *notify_baseline_checklist_initiator_option_sms
          - *notify_reviewer_option_sms
          - *notify_pi_option_sms
          - *notify_tms_option_sms


  # Defaults for Phone Screen
  contact_defaults_ps: &contact_defaults_ps
    <<: *contact_defaults
    field_options:
      prev_activity_type:
        edit_as:
          field_type: fixed_type

      contact_role:
        edit_as:
          field_type: select_contact
          alt_options:
            Phone Screen Interviewer: staff member
            MedNav: mednav reviewer
            PI: pi

    references:
      - activity_log__ipa_assignment_inex_checklist:
          label: New Message
          from: this
          add: many
          prevent_disable: true
          add_with:
            extra_log_type: contact_ps_users
            prev_activity_type: contact_ps_users
          filter_by:
            extra_log_type: contact_ps_users



  # Defaults for Baseline
  contact_defaults_baseline: &contact_defaults_baseline
    <<: *contact_defaults
    field_options:
      prev_activity_type:
        edit_as:
          field_type: fixed_type

      contact_role:
        edit_as:
          field_type: select_contact
          alt_options:
            Phone Screen Interviewer: staff member
            Navigator: baseline initiator
            PI: pi

    references:
      - activity_log__ipa_assignment_inex_checklist:
          label: New Message
          from: this
          add: many
          prevent_disable: true
          add_with:
            extra_log_type: contact_baseline_users
            prev_activity_type: contact_baseline_users
          filter_by:
            extra_log_type: contact_baseline_users



  # Defaults for TMS
  contact_defaults_tms: &contact_defaults_tms
    <<: *contact_defaults
    field_options:
      prev_activity_type:
        edit_as:
          field_type: fixed_type

      contact_role:
        edit_as:
          field_type: select_contact
          alt_options:
            MedNav: mednav reviewer
            PI: pi
            TMS: tms

    references:
      - activity_log__ipa_assignment_inex_checklist:
          label: New Message
          from: this
          add: many
          prevent_disable: true
          add_with:
            extra_log_type: contact_tms_users
            prev_activity_type: contact_tms_users
          filter_by:
            extra_log_type: contact_tms_users




_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if

####
# Phone Screen Review - checklist
# Remains editable until PI has signed it
####
phone_screen_review:
  label: Fill Phone Screen Review

  references:
    ipa_inex_checklist:
      from: this
      add: one_to_this
      filter_by:
        fixed_checklist_type: phone screen review
  caption_before:
    all_fields: |
      Edit to review and correct the checklist.
      <i>Note: form changes are not saved until all fields are validated as being completed.
      When Save is clicked you will be warned if any fields are not set. If necessary, set any that are blank and save again.</i>

  # This activity is always created automatically by the completion of the
  # phone screen being finalized
  creatable_if:
    never: true
  # Editable until the PI has signed
  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
  view_options:
    show_embedded_at_top: true

  save_action:
    on_create: create_next_creatable

####
# ADL Informant Screener - only if needed
####
adl_informant_screener:
  label: ADL Informant Screener
  references:
    dynamic_model__ipa_adl_informant_screener:
      from: master
      view_as:
        new: readonly
        edit: readonly
  caption_before:
    all_fields: Results of the Phone Screen T-MoCA indicate an ADL Informant Screener must be filled out. If the ADL Informant Screener has been received it will be shown after saving this item.

  # We expect the informant screener activity to be created automatically during
  # creation of the phone screen checklist (if necessary).
  # For now, keep this as a placeholder to ensure the user is prompted if
  # the appropriate trigger has not been updated
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
    all_2:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: informant_details
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: adl_informant_screener
  editable_if:
    never: true

  showable_if:
    <<: *enabled_if
    all_adl:
      dynamic_model__ipa_inex_checklists:
        fixed_checklist_type: phone screen review
        ix_tmoca_score_blank_yes_no: 'yes'

####
# Staff Member Signs Phone Screen checklist
####
sign_phone_screen_staff:
  label: Sign Phone Screen Review (Staff)
  fields:
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

    any:
      not_any:
        activity_log__ipa_assignment_phone_screens:
          extra_log_type: informant_details
      all:
        activity_log__ipa_assignment_phone_screens:
          extra_log_type: informant_details
        activity_log__ipa_assignment_inex_checklists:
          extra_log_type: adl_informant_screener

  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"

  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_phone_screen_staff
              signed_no_yes: "yes"

  # Notify the Reviewer that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        - *notify_reviewer_checklist_ready
        - *notify_reviewer_sms_checklist_ready


####
# Reviewer Signs Phone Screen checklist
####
sign_phone_screen_reviewer:
  label: Sign Phone Screen Review (Reviewer)
  fields:
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Review the checklist. When ready, sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_reviewer
        signed_no_yes: "yes"

    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_staff
        signed_no_yes: "yes"


  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_reviewer
        signed_no_yes: "yes"

  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_phone_screen_reviewer
              signed_no_yes: "yes"

  # Notify the PI that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        - *notify_pi_checklist_ready
        - *notify_pi_sms_checklist_ready



####
# PI Signs Phone Screen checklist
# This has the side-effect of locking the checklist to prevent further edits
# The creator of the checklist is notified at this point
####
sign_phone_screen:
  label: Sign Phone Screen Review (PI)
  fields:
    - select_subject_eligibility
    - notes
    - signed_no_yes
  caption_before:
    all_fields: "Review the checklist and confirm the subject's eligibility. When ready, select the subject's eligibility and sign the checklist by selecting <b>yes</b> in the <b>signed</b> field."
  creatable_if:
    <<: *enabled_if

    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen_reviewer
        signed_no_yes: "yes"

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"

  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'


  save_trigger:
    on_create:
      notify:
        <<: *notify_ps_checklist_initiator
        subject: "IPA App: Inclusion / Exclusion checklist signed by PI"
        if:
          all:
            this:
              signed_no_yes: 'yes'





####
# TMS Review
####
tms_responses:
  label: TMS Responses
  references:
    dynamic_model__ipa_tms_review:
      from: any
      view_as:
        new: readonly
        edit: readonly
  caption_before:
    all_fields: TMS responses from the participant's Phone Screener

  # We expect the TMS Responses activity to be created automatically during
  # creation of the phone screen checklist.
  # For now, keep this as a placeholder to ensure the user is prompted if
  # the appropriate trigger has not been updated
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: tms_responses
  editable_if:
    never: true



####
# TMS Signs TMS eligibility
####
sign_tms_eligibility:
  label: Submit TMS Eligibility
  fields:
    - select_subject_eligibility
    - notes
    - signed_no_yes


  field_options:
    select_subject_eligibility:
      edit_as:
        alt_options:
          - eligible for TMS
          - not eligible for TMS


  caption_before:
    all_fields: |
      Review the participant's responses for TMS eligibility.
      When ready, select the eligibility and sign your decision by selecting <b>yes</b> in the <b>signed</b> field.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: tms_responses

    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_tms_eligibility
        signed_no_yes: "yes"

  editable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_tms_eligibility
        signed_no_yes: "yes"

  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'

  # Notify the Reviewer that the TMS decision has been signed
  save_trigger:
    on_save:
      notify:
        <<: *notify_reviewer
        subject: "IPA App: TMS eligibility review completed"
        if:
          all:
            this:
              signed_no_yes: 'yes'




####
# Baseline review - checklist
# Navigator fills out the baseline review
# Remains editable until PI has signed it
####
baseline_review:
  label: Fill Baseline Review

  references:
    ipa_inex_checklist:
      from: this
      add: one_to_this
      filter_by:
        fixed_checklist_type: baseline review
  caption_before:
    all_fields: Fill out the checklist.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_phone_screen
        signed_no_yes: "yes"
    not_any:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"

  view_options:
    show_embedded_at_top: true

  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'

  save_action:
    on_create: create_next_creatable



####
# Navigator Signs Baseline checklist
####
sign_baseline_staff:
  label: Sign Baseline Review (Navigator)
  fields:
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"


  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'

  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignments
        if:
          any:
            activity_log__ipa_assignment_inex_checklists:
              extra_log_type: sign_baseline_staff
              signed_no_yes: "yes"

  # Notify the PI that the checklist is ready for review and signature
  save_trigger:
    on_save:
      notify:
        - *notify_pi_checklist_ready
        - *notify_pi_sms_checklist_ready


####
# PI Signs Baseline checklist
# This has the side-effect of locking the checklist to prevent further edits
####
sign_baseline:
  label: Sign Baseline Review (PI)
  fields:
    - select_subject_eligibility
    - notes
    - signed_no_yes
  caption_before:
    all_fields: Select the subject's eligibility and sign the checklist by selecting <b>yes</b> in the <b>signed</b> field.
  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline_staff
        signed_no_yes: "yes"



  editable_if:
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: sign_baseline
        signed_no_yes: "yes"

  valid_if:
    on_save:
      all:
        this:
          signed_no_yes: 'yes'

##########################################

####
# Phone Screen checklist review -
# contact all phone screen checklist users
####
contact_ps_users:
  label: Create Phone Screen Discussion

  <<: *contact_defaults_ps

  caption_before:
    all_fields: |
      Use this activity to contact the selected role about the phone screen checklist.
      Note: messages are visible to all phone screen checklist users.
    submit: After clicking <i>Send</i> the selected role will be notified.

  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review

####
# Baseline checklist review -
# contact all baseline checklist users
####
contact_baseline_users:
  label: Create Baseline Discussion

  <<: *contact_defaults_baseline

  caption_before:
    notes: |
      Use this activity to contact the selected role about the baseline checklist.
      Note: messages are visible to all baseline checklist users.
    submit: After clicking <i>Send</i> the selected role will be notified.


  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review



####
# TMS review process -
# contact all TMS review users
####
contact_tms_users:
  label: Create TMS Review Discussion

  <<: *contact_defaults_tms


  caption_before:
    notes: |
      Use this activity to contact the selected role about the TMS eligibility review.
      Note: messages are visible to all baseline checklist users.
    submit: After clicking <i>Send</i> the selected role will be notified.

  creatable_if:
    <<: *enabled_if
    not_all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: baseline_review



##########################
supporting_files:
  label: Supporting Files

  fields:
    - notes

  caption_before:
    notes: Describe the files in this container. Individual files can also be given a title and description in the file classifications.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review

  editable_if:
    <<: *enabled_if

  save_trigger:
    on_create:
      <<: *create_filestore_container

  references:
    nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container

notes:
  label: Notes
  fields:
    - notes

  caption_before:
    notes: Record notes and observations to support decisions or to assist in later reviews. The entry will editable until another log entry is made.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_inex_checklists:
        extra_log_type: phone_screen_review

  editable_if:
  # lock the item when the next log is added by making editable_if null
