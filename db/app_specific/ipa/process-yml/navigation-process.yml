_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container:
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: event documents
        label: Event Documents
        create_with_role: nfs_store group 600



_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if
  editable_if:
    always: true

  view_options:
    alt_order:
      - event_date
      - start_time
  valid_if:
    on_save:
      not_any:
        this:
          select_station: null
          event_date: null
          start_time: null



planned_event:
  label: Planned Event
  fields:
  - select_station
  - event_date
  - start_time
  - completion_time
  - select_status
  - other_navigator_notes


  references:
    dynamic_model__ipa_station_contact:
      label: Tech Contacts
      from: this
      add: many
      view_as:
        show: not_embedded
        edit: select_or_add
        new: select_or_add

    activity_log__ipa_assignment_navigation:
      label: Event Feedback
      from: master
      add: many
      add_with:
        extra_log_type: station_event
        event_date: "{{event_date}}"
        start_time: "{{start_time}}"
        select_station: "{{select_station}}"
      view_as:
        edit: hide
        show: hide
        new: outside_this



station_event:
  label: Station Event Feedback
  fields:
  - select_station
  - event_date
  - arrival_time
  - start_time
  - event_notes
  - completion_time
  - participant_feedback_notes
  - other_navigator_notes

  caption_before:
    add_protocol_deviation_record_no_yes:
      keep_label: true
      caption: If the event involved a <i>protocol deviation</i> or <i>adverse event</i>, select <b>yes</b> and save this event, then complete the appropriate form.
    reference_activity_log__ipa_assignment_protocol_deviation: If necessary, create a <i>protocol deviation</i> or <i>adverse event</i> record.



  save_trigger:
    on_create:
      <<: *create_filestore_container

  references:
    <<: *ref_filestore_container

    activity_log__ipa_assignment_protocol_deviation:
      label: Protocol Deviation Record
      from: this
      add: many
      add_with:
        extra_log_type: deviation_record
        deviation_occurred_when: "{{event_date}}"
        deviation_discovered_when: "{{event_date}}"

    activity_log__ipa_assignment_adverse_event:
      label: Adverse Event
      from: this
      add: many
      add_with:
        extra_log_type: adverse_event_record
        event_occurred_when: "{{event_date}}"
        event_discovered_when: "{{event_date}}"



general_event:
  label: General Event Feedback
  fields:
  - event_date
  - select_event_type
  - other_event_type
  - start_time
  - event_notes
  - completion_time
  - participant_feedback_notes
  - other_navigator_notes

  show_if:
    other_event_type:
      select_event_type: other

  valid_if:
    on_save:
      not_any:
        this:
          event_date: null
          start_time: null

  caption_before:
    add_protocol_deviation_record_no_yes:
      keep_label: true
      caption: If the event involved a <i>protocol deviation</i> or <i>adverse event</i>, select <b>yes</b> and save this event, then complete the appropriate form.
    reference_activity_log__ipa_assignment_protocol_deviation: If necessary, create a <i>protocol deviation</i> or <i>adverse event</i> record.



  save_trigger:
    on_create:
      <<: *create_filestore_container


  references:
    <<: *ref_filestore_container

    activity_log__ipa_assignment_protocol_deviation:
      label: Protocol Deviation Record
      from: this
      add: many
      add_with:
        extra_log_type: deviation_record
        deviation_occurred_when: "{{event_date}}"
        deviation_discovered_when: "{{event_date}}"

    activity_log__ipa_assignment_adverse_event:
      label: Adverse Event
      from: this
      add: many
      add_with:
        extra_log_type: adverse_event_record
        event_occurred_when: "{{event_date}}"
        event_discovered_when: "{{event_date}}"
