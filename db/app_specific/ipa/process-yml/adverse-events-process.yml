# @library ipa enabled_if

_definitions:

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: event documents
        label: Event Documents
        create_with_role: nfs_store group 600




_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if


  view_options:
    hide_unless_creatable: true
    always_embed_reference: dynamic_model__ipa_adverse_event

adverse_event_record:
  label: Record Adverse Event
  fields:

  editable_if:
    not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: pi_review
            id:
              this_references: id

  save_trigger:
    on_create:
      <<: *create_filestore_container

      notify:
      - type: email
        role: email - adverse event review
        layout_template: ipa notification layout
        content_template: ipa adverse event message
        subject: "IPA App: Adverse Event needs initial review"
      - type: sms
        role: sms - adverse event review
        layout_template: standard sms layout
        content_template: ipa sms notification
        subject: Adverse Event

  references:

  # Always show the record that contains event details
  - dynamic_model__ipa_adverse_event:
      from: this
      add: one_to_this

  # The initial review can be performed at any time until the PI review has been completed
  # It does not block PI review
  - activity_log__ipa_assignment_adverse_event:
      label: Initial Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: initial_review
      filter_by:
        extra_log_type: initial_review

      creatable_if:
        all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: adverse_event_record
            id:
              this: id

        not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: pi_review
            id:
              this_references: id

  # The PI review can be performed at any time until the event is reported to the IRB
  # It is not blocked by initial review and can happen in place of it
  # The rules around which type of events need PI review still stand, but are not enforced
  # here, since the PI may select to just handle the items before initial review has classified them
  - activity_log__ipa_assignment_adverse_event:
      label: PI Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: pi_review
      filter_by:
        extra_log_type: pi_review
      creatable_if:
        all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: adverse_event_record
            id:
              this: id

        not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: report_to_irb
            id:
              this_references: id


  - activity_log__ipa_assignment_adverse_event:
      label: Report to IRB
      from: this
      add: one_to_this
      add_with:
        extra_log_type: report_to_irb
      filter_by:
        extra_log_type: report_to_irb
      creatable_if:
        all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: pi_review
            id:
              this_references: id

          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  this_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  this_references: id


        not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: report_to_irb
            id:
              this_references: id

  - nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container


# Initial review will be performed by a qualified person, such as an on-site RN, or an assigned person remotely
# This activity does not block the PI review
initial_review:
  fields:
    - select_who
    - done_when
    - notes

  label: Completed Initial Review

  field_options:
    select_who:
      edit_as:
        field_type: select_user_with_role_user_-_adverse event

  caption_before:
    all_fields: <b>Review the Event and update the details and severity if necessary before continuing.</b>
    select_who: Who performed this review(if recording this action for somebody else)?
    done_when: When was this task performed?
    notes: Record any notes related to the review. If necessary, files may be uploaded below to provide additional supporting information.

    submit: Review the Adverse Event and update the details and severity if necessary. When complete, click <b>Complete</b>. If the incident is <b>internal</b> or <b>serious</b>, and <b>unexpected</b> and <b>related</b> / <b>possibly related</b> the PI will be notified.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
  save_trigger:
    on_create:
      notify:
      - type: email
        role: email - adverse event pi
        layout_template: ipa notification layout
        content_template: ipa adverse event message
        subject: "IPA App: Adverse Event needs review"
        if: &notify_conditions_pi
          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id
      - type: sms
        role: sms - adverse event pi
        layout_template: standard sms layout
        content_template: ipa sms notification
        subject: Adverse Event
        if: *notify_conditions_pi

pi_review:
  label: Complete PI Review
  fields:
    - select_who
    - done_when
    - notes

  caption_before:
    all_fields: <b>Review the Event and update the details and severity if necessary before continuing.</b>
    select_who: Who performed this review (if recording this action for somebody else)?
    done_when: When was this task performed?
    notes: Record any notes related to the review. If necessary, files may be uploaded below to provide additional supporting information.
    submit: Review the Adverse Event. When complete, click <b>Complete</b>. If the incident is <b>internal</b> or <b>serious</b>, and <b>unexpected</b> and <b>related</b> / <b>possibly related</b>, a staff member will be notified and will complete the report for the IRB.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true

  save_trigger:
    on_create:
      notify:
      - type: email
        role: email - adverse event irb report
        layout_template: ipa notification layout
        content_template: ipa adverse event message
        subject: "IPA App: Adverse Event needs IRB report"
        if: &notify_conditions_irb_report
          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id

      - type: sms
        role: sms - adverse event irb report
        layout_template: standard sms layout
        content_template: ipa sms notification
        subject: Adverse Event
        if: *notify_conditions_irb_report


report_to_irb:
  label: Completed Report to IRB
  fields:
    - select_who
    - done_when
    - notes

  caption_before:
    select_who: Who performed this task (if recording this action for somebody else)?
    done_when: When was this task performed?
    notes: Record any notes related to the review. If necessary, files may be uploaded below to provide additional supporting information.

    submit: When the <b>internal</b> or <b>serious</b>, and <b>unexpected</b> and <b>related</b> / <b>possibly related</b> Adverse Event has been reported to the IRB, click <b>Complete</b>.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
