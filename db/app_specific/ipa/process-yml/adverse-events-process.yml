_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  ref_filestore_container: &ref_filestore_container
    nfs_store__manage__container: &ref_nfs_store__manage__container
      from: this
      add: one_to_this
      view_as:
        edit: hide
        show: filestore
        new: not_embedded
      creatable_if:
        never: true

  save_trigger:
    on_create_filestore_container: &create_filestore_container
      create_filestore_container:
        name: event documents
        label: Event Documents
        create_with_role: nfs_store group 600




_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if


  view_options:
    hide_unless_creatable: true
    always_embed_reference: dynamic_model__ipa_adverse_event
    data_attribute:
      - event_occurred_when
      - select_severity



adverse_event_record:
  label: Record Adverse Event
  fields:

  editable_if:
    not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: pi_review
            id:
              this_references: id

  save_trigger:
    on_create:

      <<: *create_filestore_container

      notify:
        type: email
        role: clinical research coordinator
        layout_template: ipa notification layout
        content_template: ipa adverse event message
        subject: "IPA App: Adverse Event needs initial review"

  references:
  - dynamic_model__ipa_adverse_event:
      from: this
      add: one_to_this

  - activity_log__ipa_assignment_adverse_event:
      label: Initial Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: initial_review
      filter_by:
        extra_log_type: initial_review

      creatable_if:
        all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: adverse_event_record
            id:
              this: id

        not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: initial_review
            id:
              this: id

  - activity_log__ipa_assignment_adverse_event:
      label: PI Review
      from: this
      add: one_to_this
      add_with:
        extra_log_type: pi_review
      filter_by:
        extra_log_type: pi_review
      creatable_if:
        all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: initial_review
            id:
              this_references: id

          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  this_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  this_references: id


        not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: pi_review
            id:
              this_references: id


  - activity_log__ipa_assignment_adverse_event:
      label: Report to IRB
      from: this
      add: one_to_this
      add_with:
        extra_log_type: report_to_irb
      filter_by:
        extra_log_type: report_to_irb
      creatable_if:
        all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: pi_review
            id:
              this_references: id

          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  this_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  this_references: id


        not_all:
          activity_log__ipa_assignment_adverse_events:
            extra_log_type: report_to_irb
            id:
              this_references: id

  - nfs_store__manage__container:
      <<: *ref_nfs_store__manage__container



initial_review:
  label: Completed Initial Review
  caption_before:
    submit: Review the Adverse Event and update the details and severity if necessary. When complete, click <b>Complete</b>. If the incident is <b>internal</b> or <b>serious</b>, and <b>unexpected</b> and <b>related</b> / <b>possibly related</b> the PI will be notified.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
  save_trigger:
    on_create:
      notify:
        type: email
        role: pi
        layout_template: ipa notification layout
        content_template: ipa adverse event message
        subject: "IPA App: Adverse Event needs review"
        if:
          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id


pi_review:
  label: Complete PI Review
  caption_before:
    submit: Review the Adverse Event. When complete, click <b>Complete</b>. If the incident is <b>internal</b> or <b>serious</b>, and <b>unexpected</b> and <b>related</b> / <b>possibly related</b>, a staff member will be notified and will complete the report for the IRB.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true

  save_trigger:
    on_create:
      notify:
        type: email
        role: clinical research coordinator
        layout_template: ipa notification layout
        content_template: ipa adverse event message
        subject: "IPA App: Adverse Event needs IRB report"
        if:
          any:
            all:
              dynamic_model__ipa_adverse_events:
                select_location: internal
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id


            all2:
              dynamic_model__ipa_adverse_events:
                select_severity: serious
                select_expectedness: unexpected
                select_relatedness:
                - related
                - possibly related
                id:
                  parent_references: id



report_to_irb:
  label: Completed Report to IRB
  caption_before:
    submit: When the <b>internal</b> or <b>serious</b>, and <b>unexpected</b> and <b>related</b> / <b>possibly related</b> Adverse Event has been reported to the IRB, click <b>Complete</b>.
  save_action:
    label: Complete
  showable_if:
    never: true
  creatable_if:
    never: true
