_definitions:
  enabled_if: &enabled_if

    # if performed a phone screening no consent to continue, disable after 14 days
    not_all_not_interested:
      any:
        dynamic_model__ipa_ps_initial_screenings:
          select_is_good_time_to_speak: not interested
          select_may_i_begin: not interested
          select_still_interested: 'no'

      all_created_at:
        dynamic_model__ipa_ps_initial_screenings:
          created_at:
            condition: <
            value: -14 days

    # if recorded a withdraw activity, disable after 14 days
    not_all_withdraw:
      any:
        dynamic_model__ipa_withdrawals:
          select_subject_withdrew_reason: withdrew
          select_investigator_terminated:
            - yes - due to ae
            - yes - other reason
          lost_to_follow_up_no_yes: 'yes'
          no_longer_participating_no_yes: 'yes'
      all_created_at:
        dynamic_model__ipa_withdrawals:
          created_at:
            condition: <
            value: -14 days

    # if performed a screening follow up and not eligible, disable after 14 days
    not_all_ineligible:
      dynamic_model__ipa_screenings:
        eligible_for_study_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if performed a screening follow up and not interested in participating, disable after 14 days
    not_all_ps_followup_not_interested:
      dynamic_model__ipa_screenings:
        still_interested_blank_yes_no: 'no'
        created_at:
          condition: <
          value: -14 days

    # if the exit survey has been completed, disable after 14 days
    not_all_complete:
      activity_log__ipa_assignments:
        extra_log_type: follow_up_surveys
      dynamic_model__ipa_surveys:
        select_survey_type: exit survey
        created_at:
          condition: <
          value: -14 days

  # Rule for editable_if only
  # Lock the forms on finalization
  not_finalized: &not_finalized
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: finalize


  ####
  # Boilerplace for notifying roles
  # Override the subject: and if: structures to refine operation
  ####

  # Default email - just add roles or users
  notify_email_default: &notify_email_default
    type: email
    layout_template: ipa notification layout
    content_template: ipa inex message
    subject: "IPA App: Phone Screen Complete"


  # Default SMS - just add roles or users
  notify_sms_default: &notify_sms_default
    type: sms
    layout_template: standard sms layout
    content_template: ipa sms notification
    subject: "IPA Phone Screen Complete"



  # MedNav reviewer
  notify_reviewer: &notify_reviewer
    <<: *notify_email_default
    role: email - inex reviewer

  # MedNav reviewer SMS
  notify_reviewer_sms: &notify_reviewer_sms
    <<: *notify_sms_default
    role: sms - inex reviewer

  # PI
  notify_pi: &notify_pi
    <<: *notify_email_default
    role: email - inex pi


  # PI SMS
  notify_pi_sms: &notify_pi_sms
    <<: *notify_sms_default
    role: sms - inex pi


_default:
  showable_if: *enabled_if
  creatable_if: *enabled_if
  editable_if: *not_finalized
  save_action:
    on_create: create_next_creatable

start_phone_screen:
  label: Start Phone Screening
  fields:

  references:
    dynamic_model__ipa_ps_initial_screening:
      from: this
      add: one_to_this

  caption_before:
    all_fields: Record initial screening responses. If necessary, enter a date and time to follow up.
    submit: If the subject is ready to continue, save this form and continue with the next form.
  view_options:
    show_embedded_at_top: true

  creatable_if:
    <<: *enabled_if
    not_any:
      dynamic_model__ipa_ps_initial_screenings:
        select_still_interested: "yes"


  save_action:
    on_create:
      create_next_creatable:
        if:
          all:
            dynamic_model__ipa_ps_initial_screenings:
              select_still_interested: "yes"
              id:
                this_references: id
      show_panel:
        value: activity_log__ipa_assignments
        if:
          not_all:
            dynamic_model__ipa_ps_initial_screenings:
              select_still_interested: "yes"
              id:
                this_references: id
      hide_panel:
        value: activity_log__ipa_assignment_phone_screens
        if:
          not_all:
            dynamic_model__ipa_ps_initial_screenings:
              select_still_interested: "yes"
              id:
                this_references: id

  showable_if:
    always: true

  save_trigger:
    on_create:

      create_reference:

        - activity_log__ipa_assignment:
            if:
              all:
                dynamic_model__ipa_ps_initial_screenings:
                  id:
                    this_references: id
                this:
                  any:
                    dynamic_model__ipa_ps_initial_screenings:
                      select_is_good_time_to_speak:
                        - left voicemail
                        - not appropriate time
                      select_still_interested: 'yes - call back'

            in: master
            with:
              extra_log_type: schedule_screening
              select_who: current_user_email
              follow_up_when:
                dynamic_model__ipa_ps_initial_screenings:
                  id:
                    this_references: id
                  follow_up_date: return_value
              follow_up_time:
                dynamic_model__ipa_ps_initial_screenings:
                  id:
                    this_references: id
                  follow_up_time: return_value
              notes: Phone screen call when to voicemail or participant requested a call back
              select_record_from_player_contacts:
                activity_log__ipa_assignments:
                  extra_log_type: schedule_screening
                  select_record_from_player_contacts: return_value

#section_1:
#  label: Football Experience
#  fields:
#  references:
#    dynamic_model__ipa_ps_football_experience:
#      from: this
#      add: one_to_this
#  creatable_if:
#    <<: *enabled_if
#    all:
#      activity_log__ipa_assignment_phone_screens:
#        extra_log_type: start_phone_screen
#      dynamic_model__ipa_ps_initial_screenings:
#        select_still_interested: "yes"
#    not_any:
#      activity_log__ipa_assignment_phone_screens:
#        extra_log_type: section_1


section_2:
  label: General Info
  fields:
  references:
    dynamic_model__ipa_ps_size:
      from: this
      add: one_to_this

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: start_phone_screen
      dynamic_model__ipa_ps_initial_screenings:
        select_still_interested: "yes"
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: section_2


health_1:
  label: Health
  fields:
  references:
    dynamic_model__ipa_ps_health:
      from: this
      add: one_to_this
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: section_2
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: health_1

sleep_1:
  label: Sleep
  fields:
  references:
    dynamic_model__ipa_ps_sleep:
      from: this
      add: one_to_this

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: health_1
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: sleep_1


mri_1:
  label: MRI
  fields:
  references:
    dynamic_model__ipa_ps_mri:
      from: this
      add: one_to_this

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: sleep_1
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: mri_1


tms_1:
  label: TMS
  fields:
  references:
    dynamic_model__ipa_ps_tms_test:
      from: this
      add: one_to_this
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: mri_1
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tms_1


tmoca_0:
  label: Continue?
  fields:
    - callback_required
    - callback_date
    - callback_time
    - placeholder_callback
    - notes

  caption_before:
    all_fields: |
      Thank you for your patience and for answering the previous questions.
      I am now going to ask you to do some tasks and will provide you with instructions throughout. This should take approximately 15 minutes.
    callback_required: Do you have still have time to complete this right now or would you like me to call you back at a more convenient time?
    notes: Enter any notes from the end of the call. If the subject no longer wishes to participate, enter a Withdraw record in the IPA Tracker.
    placeholder_callback: When calling back the participant, click <b>Continue?</b> in the menu above to restart the screener process.

  field_options:
    callback_required:
      edit_as:
        field_type: select_callback_required
        alt_options:
          "Yes, ok to continue": 'ok to continue'
          "No - Thank and end call": 'not ok to continue'
          "Yes, but call me back": 'call me back'

  show_if:
    callback_date:
      callback_required: 'call me back'
    callback_time:
      callback_required: 'call me back'
    notes:
      callback_required: 'not ok to continue'
    placeholder_callback:
      callback_required: 'call me back'

#  references:
#    activity_log__ipa_assignment:
#      from: this
#      add: many
#      add_with:
#        extra_log_type: withdraw


  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tms_1
    not_all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tmoca_0
        callback_required:
          - ok to continue
          - not ok to continue


  save_action:
    on_create:
      create_next_creatable:
        if:
          all:
            this:
              callback_required: "ok to continue"

      show_panel:
        value: activity_log__ipa_assignments
        if:
          all:
            this:
              callback_required: call me back


  save_trigger:
    on_create:

      create_reference:

        - activity_log__ipa_assignment:
            if:
              all:
                this:
                  callback_required: call me back

            in: master
            with:
              extra_log_type: schedule_screening
              select_who: current_user_email
              follow_up_when:
                this:
                  callback_date: return_value
              follow_up_time:
                this:
                  callback_time: return_value
              notes: Participant requested a call back before commencing with T-MoCA
              select_record_from_player_contacts:
                activity_log__ipa_assignments:
                  extra_log_type: schedule_screening
                  select_record_from_player_contacts: return_value


tmoca_1:
  label: T-MoCA


  caption_before:
    all_fields: |
      Okay great.  You will need a pencil or pen to complete this portion… Are you ready?<hr>
      <b>When questions are complete</b>
      Thank you for your patience and for answering these previous questions.

      Please note that we will keep this information with your research records. As I mention before, some of your responses may be shared with our Football Player Health Study staff members and you may be contacted to participate in additional research opportunities.

      I have recorded your answers to the questions and these will be reviewed by a study physician to determine whether you are eligible for the study.

      May I put you on a brief hold while I finish that up?

      <i>Enter scores and save when complete</i>

  references:
    dynamic_model__ipa_ps_tmoca:
      from: this
      add: one_to_this

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tmoca_0
        callback_required: "ok to continue"

    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tmoca_1



#cognitive_screening_completed:
#  label: Cognitive Screening Completed
#  caption_before:
#    all_fields: |
#      Thank you for your patience and for answering these previous questions.
#
#      Please note that we will keep this information with your research records. As I mention before, some of your responses may be shared with our Football Player Health Study staff members and you may be contacted to participate in additional research opportunities.
#
#      I have recorded your answers to the questions and these will be reviewed by a study physician to determine whether you are eligible for the study. We will contact you to let you know if you are eligible.
#
#  creatable_if:
#    <<: *enabled_if
#    all:
#      activity_log__ipa_assignment_phone_screens:
#        extra_log_type: tmoca_1
#    not_any:
#      activity_log__ipa_assignment_phone_screens:
#        extra_log_type: cognitive_screening_completed


informant_details:
  label: Informant Details
  caption_before:
    all_fields: |
      <i>[For those who scored &lt;= 19 on the T-MoCA ONLY]</i>

      The next step of this screening process is to speak to a close family member who knows you well or someone who can legally make decisions for you to ask them questions about your memory. For example, we will ask them to tell us if you need reminders or help with activities such as keeping track of appointments, household chores and personal care. We will also ask them to tell us about your mood – for example, if you get anxious or irritated. This will entail a brief phone call with the individual you decide to provide contact information for. Following the phone call, we will send them an individualized link via email which will contain a 23 -question survey. This survey will not contain any identifiable information – for instance, it will not contain your name, address, or birthdate and your family member will not be asked to provide this information either.

      Do we have your permission to speak to someone that knows you well?

  references:
    dynamic_model__ipa_ps_informant_detail:
      from: master
      add: one_to_master

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tmoca_1
      dynamic_model__ipa_ps_tmocas:
        tmoca_score:
          condition: <=
          value: 19

    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: informant_details

  save_trigger:
    on_create:
      create_reference:
        - activity_log__ipa_assignment:
            in: master
            with:
              extra_log_type: schedule_informant_screener
              notes: ADL Informant Screener required based on T-MoCA result. Schedule a call with the informant.



schedule_callback:
  label: Schedule Callback
  fields:
    - callback_date
    - callback_time
    - notes
  caption_before:
    all_fields: |
      Thank you for your patience and for answering these previous questions.

       We will then contact you to let you know if you are eligible or not. If you are eligible, we will let you know the next steps.

       Do you have any questions?

       We will call you back to inform you of your eligibility status. What is a good day/time to call you? It may take up to 10 days for us to make a determination.


    submit: If you have any questions in the meantime, please do not hesitate to contact us. Thank you again for your time.

  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: tmoca_1
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: schedule_callback


  save_trigger:
    on_create:

      create_reference:

        - activity_log__ipa_assignment:

            in: master
            with:
              extra_log_type: screening_follow_up
              select_who: current_user_email
              follow_up_when:
                this:
                  callback_date: return_value
              follow_up_time:
                this:
                  callback_time: return_value
              notes: Participant phone screening completed. Follow-up has been scheduled.
              select_record_from_player_contacts:
                activity_log__ipa_assignments:
                  extra_log_type: schedule_screening
                  select_record_from_player_contacts: return_value



finalize:
  label: Finalize Entries
  caption_before:
    all_fields: |
      When finalized the phone screen forms are locked from editing.
    submit: |
      Save this entry to lock the phone screen forms and generate an inclusion/exclusion checklist record.
      Click the cancel button instead if review or revision of the phone screen forms is still required.
  creatable_if:
    <<: *enabled_if
    all:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: schedule_callback
    not_any:
      activity_log__ipa_assignment_phone_screens:
        extra_log_type: finalize


  # Override the default that hides activities after a certain stage,
  # so that any user can see that the phone screen process has been completed
  showable_if:
    always: true


  save_action:
    on_create:
      show_panel:
        value: activity_log__ipa_assignment_inex_checklists
      hide_panel:
        value: activity_log__ipa_assignment_phone_screens

  save_trigger:
    on_create:
      create_reference:
        - activity_log__ipa_assignment_inex_checklist:
            in: master
            with:
              extra_log_type: tms_responses


  # Notify the reviewers that the phone screen has been completed
      notify:
        - *notify_reviewer
        - *notify_reviewer_sms
#        - *notify_pi
#        - *notify_pi_sms
