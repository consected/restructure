var _nfs_store={fs_browser:function(l){"use strict";var d={},e=function(){return $('.container-browser-outer[data-container-id="'+b+'"] .container-browser')},c=function(e,t,n,o){a("download",e,t),a("trash",e,t),a("move-files",e,t),t?(a("rename-file",e,t),a("rename-folder",e,t)):(a("rename-file",e,t=1!=n),a("rename-folder",e,t=1!=o))},a=function(e,t,n){n||(n=!("true"==w.attr("data-can-submit-"+e)));var o=n?"disabled":null;$("#container-browse-"+e+"-"+b).attr("disabled",o),$("#container-browse-"+e+"-in-form-"+b).attr("disabled",o)},f=function(e,t){$("#container-browse-download-"+b+" .btn-caption").html(t)},t=function(){var e=$("#container-browse-download-in-form-"+b),t=e.parents("form").first();t.removeAttr("data-remote"),t.removeData("remote"),e.click()},o=function(e,t,n){var o=$("#container-browse-"+t+"-in-form-"+b),a=o.parents("form").first();if(a&&0!==a.length){var r=a.find(".extra_params");if(r.html(""),n)for(var i in n)if(n.hasOwnProperty(i)){var s=n[i];s=s.replace(/"/,"&quot;"),r.append('<input type="hidden" name="nfs_store_download['+i+']" value="'+s+'" />')}a.attr("data-remote","true"),a[0].app_callback=function(){p(l,b)},o.click()}},p=function(e,t){$('.refresh-container-list[data-container-id="'+t+'"]').click(),n(e)},n=function(e){l.removeClass("ajax-running"),c(e,!0),s(e)},r=function(e,t,n){t.stopPropagation();var o=w.find('.folder-icon[aria-controls="'+e.attr("id")+'"]');n?(o.removeClass("folder-open"),o.addClass("glyphicon-folder-close"),o.removeClass("glyphicon-folder-open"),o.attr("title","expand folder")):(o.addClass("folder-open"),o.addClass("glyphicon-folder-open"),o.removeClass("glyphicon-folder-close"),o.attr("title","shrink folder"))},i=function(e,t){var n=l.find(".container-browser");if(n.addClass("browser-hide-meta browser-hide-classifications"),e||(e=$('input[name="container-meta-controls-'+b+'"]:checked')),e){var o=e.val();n.removeClass("browser-hide-"+o)}if(!(0<l.parents(".multi-model-reference-result .is-activity-log").length)){var a=l.parents(".common-template-item.is-activity-log").first(),r=a.hasClass("col-md-8"),i=!1;a.removeClass("col-md-8 col-lg-6 col-lg-8 col-md-12 col-lg-12"),"classifications"==o?a.addClass("col-md-12 col-lg-12"):"meta"==o?a.addClass("col-md-12 col-lg-12"):(i=!0,a.addClass("col-md-8 col-lg-6")),r!=i&&window.setTimeout(function(){t||_fpa.utils.jump_to_linked_item(a,null,{no_highlight:!0}),_fpa.form_utils.resize_children(l)},100)}},s=function(e){var t=w.find('.container-entry input[type="checkbox"]:checked'),n=w.find('.container-folder input[type="checkbox"]:checked'),o=t.length,a=n.length,r=t.first().siblings(".browse-filename").html(),i=t.first().parents(".container-folder-items"),s=i.not('[data-folder-items="."]').last();0!=s.length&&-1!=s.attr("data-folder-items").indexOf("__mounted-archive__")||(s=i.last()),s=s.prev().add(s);var l=i.first();return l=l.prev().add(l),f(e,"download "+o+" "+(1!=o?"files":"file")),c(e,!o,o,a),w.find(".container-entry.checked").removeClass("checked"),t.each(function(){$(this).is(":checked")&&$(this).parent().addClass("checked")}),w.find(".container-folder.checked").removeClass("checked"),n.each(function(){$(this).is(":checked")&&$(this).parent().addClass("checked")}),d={total_checked:o,total_checked_folders:a,first_file:r,$folder_top:s,$folder_in:l}},u=function(e){var t=e.parents(".container-folder-items").first(),n=t.attr("data-folder-items"),o=t.find('> .container-entry input[type="checkbox"]'),a=o.length==o.closest(":checked").length;w.find('.container-folder input[type="checkbox"][data-folder-path="'+n+'"] ').prop("checked",a),s(e)},h=function(e){var t=e.attr("data-folder-path"),n=e.is(":checked");w.find('.container-folder-items[data-folder-items="'+t+'"] li input[type="checkbox"]').prop("checked",n),s(e)},m=function(e){var t=$($(this).attr("data-target-browser")),n={};_.find(".container-browse-action-extra-params").each(function(){var e=$(this);n[e.attr("name")]=e.val()}),o(t,e,n),c(t,!0),_.modal("hide")},v=function(e,t){if(e=e.replace(/^\.?\/?/,"")){if(t)var n=[t,e].join("/");else n=e;n=(n=n.replace(/^\.?\/?/,"")).replace(/^[^\/]+\.__mounted-archive__(\/|$)/,"");_.find('input[name="new_path"]').val(n)}},g=function(){if(e=_.find(".browse-move-to-folders .container-folder.checked [data-folder-path]").first().attr("data-folder-path"))var e=(e=e.replace(/^\.?\/?/,"")).replace(/^[^\/]+\.__mounted-archive__(\/|$)/,"");_.find(".container-browser-move-from").html(e)},b=function(e){var t=e.attr("data-container-id");return t||e.parents(".container-browser-outer").attr("data-container-id")}(l),w=e();l.on("change",'.container-browser .container-entry input[type="checkbox"]',function(){u($(this))}).on("change",'.container-browser .container-folder input[type="checkbox"]',function(){h($(this))}).on("hidden.bs.collapse",".container-browser .container-folder-items",function(e){r($(this),e,!0)}).on("shown.bs.collapse",".container-browser .container-folder-items",function(e){r($(this),e,!1)}).on("click",".container-browse-download",function(){var e=$($(this).attr("data-target-browser"));t(e),c(e,!0),f(e,"request submitted")}).on("click",".container-browse-trash-submit",function(){var e=$($(this).attr("data-target-browser"));o(e,"trash"),c(e,!0)}).on("click",".container-browse-trigger-file-action",function(){var e=$($(this).attr("data-target-browser")),t=$(this).attr("data-trigger-file-action");o(e,"trigger-file-action-"+t),c(e,!0),window.setTimeout(function(){p(l,b)},1e4)}).on("click",".container-browse-move-files",function(){$($(this).attr("data-target-browser"));var e=$("#container-browse-move-files-form-"+b).html(),t="Move Files to a folder";_fpa.show_modal(e,t);var n=d.$folder_top,o=(n.find(".container-folder, .container-folder-items"),_.find(".browse-move-to-folders"));n.clone().appendTo(o),n.first().hasClass("root-folder")&&o.find(".container-folder-items").each(function(){var e=$(this);0<=e.attr("data-folder-items").indexOf(".__mounted-archive__")&&(e.prev().remove(),e.remove())}),o.find(".container-entry").remove(),o.find(".container-folder-items").each(function(){var e=$(this),n=e.prev(),t=e.attr("id");e.attr("id","bmtf-"+t),e.attr("aria-expanded","true"),e.addClass("in");var o=e.attr("data-folder-items");$('<a class="container-add"><input type="checkbox" class="container-folder-add hidden" data-folder-path="'+o+'" /> <span class="glyphicon glyphicon-plus"></span> folder</a>').appendTo(n).on("click",function(e){e.preventDefault(),$(this).find("input.container-folder-add").prop("checked",!0).change();var t=_.find(".container-new-folder-name");t.slideDown(),v(t.val(),o),t.on("keyup",function(){var e=$(this).val();v(e,o)}),n.append(t)})}),o.find(".folder-icon").each(function(){var e=$(this),t=e.attr("href");if(t){var n="#bmtf-"+t.replace(/^#/,"");e.attr("href",n),e.attr("aria-controls",n)}e.addClass("folder-open glyphicon-folder-open").removeClass("glyphicon-folder")});var a=o.find('input[type="checkbox"]');a.each(function(){$(this).prop("checked",!1)}),_.find(".container-new-folder-name").parent().slideUp(),o.on("change",'input[type="checkbox"]',function(){var e=$(this),t=e.attr("data-folder-path");a.not('[data-folder-path="'+t+'"]').prop("checked",!1);var n=_.find(".container-new-folder-name");e.hasClass("container-folder-add")||n.slideUp(),v(t)}),g()}).on("click",".container-browse-rename-file",function(){$($(this).attr("data-target-browser"));var e=$("#container-browse-rename-file-form-"+b).html(),t="Rename file";_fpa.show_modal(e,t),_.find('input[name="new_name"]').val(d.first_file)});var _=$("#primary-modal");_.on("click",".container-browse-move-files-submit",function(){m("move-files")}).on("click",".container-browse-rename-file-submit",function(){m("rename-file")}),$(document).on("click",'.refresh-container-list[data-container-id="'+b+'"]',function(){l.find(".container-browser").addClass("ajax-running")}).on("change",'input[name="container-meta-controls-'+b+'"]',function(){i($(this))});var k=$('input[name="container-meta-controls-'+b+'"]:checked');return i(k,!0),n(l),this},uploader:function(l){"use strict";function n(e,t){if(d)t=null;else{e&&(v=0,r=null,u=e,m=Math.ceil(u.size/h),i=t,!1,f=[]);var n=new FileReader;n.onload=b,n.onerror=w;var o=v*h,a=o+h>=u.size?u.size:o+h;n.readAsArrayBuffer(p.call(u,o,a))}}var r,i,d,s,o,c={url:"/nfs_store/chunk",dataType:"json",autoUpload:!1,dropZone:l.find(".upload-dropzone"),disableImageResize:!0,singleFileUploads:!0,sequentialUploads:!0,previewMaxWidth:100,previewMaxHeight:100,previewCrop:!0,maxChunkSize:1e7,headers:{"X-CSRF-Token":$('meta[name="csrf-token"]').attr("content")}},f=[],p=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,u=null,h=c.maxChunkSize,m=0,v=0,a=new SparkMD5.ArrayBuffer,g=new SparkMD5.ArrayBuffer,b=function(e){var t=e.target.result;g.reset(),g.append(t),f.push(g.end()),a.append(t),++v<m?n():(r=a.end(),!0,i&&i(r))},w=function(){!0},_=function(e,t,n,o,a){var r=l.find(".template .file-block").clone(!0).attr("data-file-index",t);r.find(".file-name").text(n.name),d=!1,r.find(".button-upload-abort").on("click",function(){var e=$(this),t=e.data();e.hide(),d=!0,r.find(".button-upload-resume").show(),t.abort()}).data(e),r.find(".button-upload-resume").on("click",function(){$(this).hide(),r.find(".button-upload-abort").show(),d=!1,x(r),F(a,o)}),r.find(".started-at").html((new Date).toLocaleTimeString());var i=l.find(".data-context");r.appendTo(i),r.data(e);var s=i.get(0).getBoundingClientRect();return!(0<=s.top&&s.top<=.8*$(window).height())&&$.scrollTo(i,0,{offset:.8*-$(window).height()}),r.find(".close").on("click",function(){r.slideUp()}),r},k=function(e){e.removeClass("process-ready").addClass("process-complete"),e.removeClass("progress-running"),C(e),console.log("completed upload of file")},y=function(e,t){t||(t=S()),e.join||(e=[e]),t.find(".file-error").text("file upload failed: "+e.join(" | ")),t.find(".progress-bar").addClass("progress-bar-failed").removeClass("progress-bar-success"),t.find(".progress-bar-status-text").text("failed"),t.removeClass("progress-running"),C(t),D()},x=function(e){e.addClass("process-ready").removeClass("process-complete"),e.find(".file-error").text(""),e.find(".progress-bar").removeClass("progress-bar-failed").addClass("progress-bar-success"),e.find(".progress-bar-status-text").text("processing")},C=function(e){e.find(".button-upload-abort").hide()},D=function(){l.find(".fileinput-button").show()},e=function(){l.find(".fileinput-button").hide()},t=function(){l.find(".data-context .file-block[data-file-index]").remove()},S=function(){return l.find(".data-context .file-block.process-ready").first()},T=function(){return l.find(".data-context .file-block")},j=function(e){var t=[],n=e.jqXHR.responseJSON;if(n&&n.message)return t.push(n.message),t;var o=e.jqXHR.getResponseHeader("X-Upload-Errors"),a=JSON.parse(o);for(var r in a)a.hasOwnProperty(r)&&t.push(r.replace("_"," ")+" "+a[r].join("; "));return 0==t.length&&t.push("unknown server error"),t},z=function(){l.find(".refresh-container-list").click()},U=function(){var e=R(),t=O(),n={activity_log_id:e.activity_log_id,activity_log_type:e.activity_log_type,container_id:t,"do":"done",uploaded_ids:s.join(",")};$.ajax({url:c.url+"/"+t,data:n,type:"PUT",success:function(){console.log("Sent all done message")}})},O=function(){return l.find("#uploader_container_id").val()},R=function(){var e=l.find(".nfs-store-container-block");return{activity_log_id:e.attr("data-activity-log-id"),activity_log_type:e.attr("data-activity-log-type")}},F=function(a,r){var e=S();if(0!=e.length){var i=e.data();d=!1,e.addClass("progress-running"),e.find(".progress-bar-status-text").text("processing"),o=o||T().length.toString()+"--"+Date.now().toString()+"--"+Math.random().toString(),n(i.files[0],function(e){i.formData||(i.formData={}),i.formData.file_hash=e,i.formData.container_id=O(),i.formData.upload_set=o,i.files[0].relativePath&&""!=i.files[0].relativePath&&(i.formData.relative_path=i.files[0].relativePath),1==f.length&&(i.formData.chunk_hash=f.shift());var t=R();if(a){var n={file_name:i.files[0].name,file_hash:i.formData.file_hash,relative_path:i.formData.relative_path,activity_log_id:t.activity_log_id,activity_log_type:t.activity_log_type};$.getJSON(c.url+"/"+O(),n,function(e){if("found"==e.result&&!e.completed){var t=e.file_size,n=e.chunk_count;i.uploadedBytes=t;for(var o=0;o<n;o++)i.formData.chunk_hash=f.shift();$.blueimp.fileupload.prototype.options.add.call(a,r,i)}setTimeout(function(){i.submit()},100)}).fail(function(e){var t=["The upload failed"];e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message),y(t)})}else setTimeout(function(){i.submit()},100)})}};l.find(".upload-dropzone").on("dragover",function(){$(this).addClass("on-drag")}).on("dragleave",function(){$(this).removeClass("on-drag")}).on("drop",function(){l.find(".fileinput-button").is(":visible")?(e(),t(),$(this).removeClass("on-drag")):console.log("Upload not enabled!")});l.find("input.nfs-store-fileupload").fileupload(c).on("click",function(){t()}).on("fileuploadadd",function(o,a){if("false"!=l.find(".container-browser").attr("data-container-writable")){e();var r=this;$.each(a.files,function(e,t){var n=0==S().length;_(a,e,t,o,r);n&&(s=[],setTimeout(function(){F(r,o)},1e3))})}else console.log("Upload not enabled!")}).on("fileuploadchunkbeforesend",function(e,t){t.formData||(t.formData={}),t.formData.chunk_hash=f.shift(),t.formData.upload_set=o,S().find(".progress-bar-status-text").text("uploading")}).on("fileuploadchunksend",function(){return!d}).on("fileuploadprocessalways",function(e,t){console.log("fileuploadprocessalways");var n=0,o=t.files[n],a=S();a.find(".progress-bar-status-text").text("uploading"),o.error&&a.find(".file-error").text(o.error)}).on("fileuploadprogress",function(e,t){var n=S(),o=parseInt(t.loaded/t.total*100,10);n.find(".progress .progress-bar").css("width",o+"%");var a=n.get(0).getBoundingClientRect();!(0<=a.top&&a.top<=.8*$(window).height())&&$.scrollTo(n,0,{offset:.8*-$(window).height()})}).on("fileuploaddone",function(e,t){console.log("fileuploadaddone");var n=t.result.file,o=S();n.url?(o.find(".progress-bar-status-text").text("completed"),s.push(n.id)):n.error&&o.find(".file-error").text(n.error)}).on("fileuploadfail",function(e,t){var n;console.log("fileuploadfail"),n=d?["Upload canceled"]:j(t),y(n)}).on("fileuploadalways",function(n,e){console.log("fileuploadalways");var o=this;$.each(e.files,function(){var e=S();e.find(".ended-at").text((new Date).toLocaleTimeString()),k(e);var t=S();!d&&0<t.length?F(o,n):(D(),z(),U())})}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?undefined:"disabled")}};